<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="pl" xml:lang="pl"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.299">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Automatyczna analiza obrazu - 14&nbsp; Segmentacja obrazów</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./references.html" rel="next">
<link href="./example.html" rel="prev">
<link href="./cover.png" rel="icon" type="image/png">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="site_libs/bootstrap/bootstrap-dark.min.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "Brak wyników",
    "search-matching-documents-text": "dopasowane dokumenty",
    "search-copy-link-title": "Kopiuj link do wyszukiwania",
    "search-hide-matches-text": "Ukryj dodatkowe dopasowania",
    "search-more-match-text": "więcej dopasowań w tym dokumencie",
    "search-more-matches-text": "więcej dopasowań w tym dokumencie",
    "search-clear-button-title": "Wyczyść",
    "search-detached-cancel-button-title": "Anuluj",
    "search-submit-button-title": "Zatwierdź"
  }
}</script>


</head>

<body class="nav-sidebar floating slimcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Przełącz pasek boczny" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
      <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./segmentation.html"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Segmentacja obrazów</span></a></li></ol></nav>
      <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Przełącz pasek boczny" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
      </a>
      <button type="button" class="btn quarto-search-button" aria-label="Szukaj" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header sidebar-header-stacked">
      <a href="./index.html" class="sidebar-logo-link">
      <img src="./images/logo.png" alt="" class="sidebar-logo py-0 d-lg-inline d-none">
      </a>
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Automatyczna analiza obrazu</a> 
        <div class="sidebar-tools-main tools-wide">
    <a href="https://twitter.com" title="" class="quarto-navigation-tool px-1" aria-label=""><i class="bi bi-twitter"></i></a>
    <a href="https://github.com/dax44/ComputerVision/" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
    <a href="https://twitter.com/intent/tweet?url=|url|" title="Twitter" class="quarto-navigation-tool px-1" aria-label="Twitter"><i class="bi bi-twitter"></i></a>
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Przełącz tryb ciemny"><i class="bi"></i></a>
  <a href="" class="quarto-reader-toggle quarto-navigation-tool px-1" onclick="window.quartoToggleReader(); return false;" title="Przełącz tryb czytnika">
  <div class="quarto-reader-toggle-btn">
  <i class="bi"></i>
  </div>
</a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Szukaj"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Wstęp</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./intro.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Wprowadzenie</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./history.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Historia wizji komputerowej</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./digt_img.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Obrazy cyfrowe</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./transformations.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Transformacje geometryczne</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./point_trans.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Transformacje punktowe</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./filters.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Filtry</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./edge.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Wykrywanie krawędzi i konturów</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./morpho.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Filtry morfologiczne</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./fourier.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Transformata Fouriera</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./deeplearning.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Deep learning</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./fundamentals.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Fundamenty DNN</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./convolution.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Sieci splotowe</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./example.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Przykład uczenia sieci splotowej</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./segmentation.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Segmentacja obrazów</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Bibliografia</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Spis treści</h2>
   
  <ul>
  <li><a href="#nowoczesne-architektury-sieci-splotowych" id="toc-nowoczesne-architektury-sieci-splotowych" class="nav-link active" data-scroll-target="#nowoczesne-architektury-sieci-splotowych"><span class="header-section-number">14.1</span> Nowoczesne architektury sieci splotowych</a>
  <ul class="collapse">
  <li><a href="#połączenia-rezydualne" id="toc-połączenia-rezydualne" class="nav-link" data-scroll-target="#połączenia-rezydualne"><span class="header-section-number">14.1.1</span> Połączenia rezydualne</a></li>
  <li><a href="#normalizacja-partii" id="toc-normalizacja-partii" class="nav-link" data-scroll-target="#normalizacja-partii"><span class="header-section-number">14.1.2</span> Normalizacja partii</a></li>
  <li><a href="#konwolucje-separowalne" id="toc-konwolucje-separowalne" class="nav-link" data-scroll-target="#konwolucje-separowalne"><span class="header-section-number">14.1.3</span> Konwolucje separowalne</a></li>
  <li><a href="#przykład-wykorzystania-sieci-xception" id="toc-przykład-wykorzystania-sieci-xception" class="nav-link" data-scroll-target="#przykład-wykorzystania-sieci-xception"><span class="header-section-number">14.1.4</span> Przykład wykorzystania sieci Xception</a></li>
  </ul></li>
  <li><a href="#co-widzi-sieć-konwolucyjna" id="toc-co-widzi-sieć-konwolucyjna" class="nav-link" data-scroll-target="#co-widzi-sieć-konwolucyjna"><span class="header-section-number">14.2</span> Co widzi sieć konwolucyjna?</a></li>
  </ul>
<div class="toc-actions"><div><i class="bi bi-github"></i></div><div class="action-links"><p><a href="https://github.com/dax44/ComputerVision/issues/new" class="toc-action">Zgłoś problem</a></p></div></div></nav>
    </div>
<!-- main -->
<main class="content page-columns page-full" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Segmentacja obrazów</span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<p>Do tej pory skupialiśmy się na modelach klasyfikacji obrazów gdzie wejściem był obraz, a wyjściem etykieta: “Ten obraz prawdopodobnie zawiera kota; ten inny prawdopodobnie zawiera psa”. Ale klasyfikacja obrazów jest tylko jednym z kilku możliwych zastosowań głębokiego uczenia w wizji komputerowej. Ogólnie rzecz biorąc, istnieją trzy podstawowe zadania wizji komputerowej:</p>
<ul>
<li>Klasyfikacja obrazu - gdy celem jest przypisanie jednej lub więcej etykiet do obrazu. Może to być klasyfikacja jednoetykietowa (obraz może należeć tylko do jednej kategorii, z pominięciem innych) lub wieloetykietowa (oznaczanie wszystkich kategorii, do których należy obraz, jak widać na <a href="#fig-seg1">Rysunek&nbsp;<span>14.1</span></a>). Na przykład, gdy wyszukujemy słowo kluczowe w aplikacji Zdjęcia Google, za kulisami odpytujemy bardzo duży model klasyfikacji wieloznakowej - jedna z ponad 20 000 różnych klas, wytrenowany na milionach obrazów.</li>
<li>Segmentacja obrazu - gdy celem jest “podział” obrazu na różne obszary, przy czym każdy obszar reprezentuje zazwyczaj kategorię (jak widać na <a href="#fig-seg1">Rysunek&nbsp;<span>14.1</span></a>). Na przykład, gdy podczas rozmowy wideo Zoom lub Google Meet wyświetlają za nami niestandardowe tła, wykorzystywana jest wówczas segmentacji obrazu, aby odróżnić naszą twarz od tego, co znajduje się za nią, z dokładnością do piksela.</li>
<li>Wykrywanie obiektów - gdzie celem jest narysowanie prostokątów (zwanych polami ograniczającymi) wokół interesujących obiektów na obrazie i powiązanie każdego prostokąta z klasą. Samochód samojezdny może używać modelu wykrywania obiektów do monitorowania samochodów, pieszych i znaków w polu widzenia kamer.</li>
</ul>
<div id="fig-seg1" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="images/Zrzut ekranu 2023-03-18 o 10.29.55.png" class="img-fluid figure-img" width="700"></p>
<p></p><figcaption class="figure-caption">Rysunek&nbsp;14.1: Przykłady wykorzystania sieci splotowych w zadaniach z wizji komputerowej</figcaption><p></p>
</figure>
</div>
<p>Głębokie uczenie dla wizji komputerowej obejmuje również szereg nieco bardziej niszowych zadań poza tymi trzema, takich jak ocena podobieństwa obrazów (szacowanie, jak bardzo dwa obrazy są podobne wizualnie), wykrywanie punktów kluczowych (wskazywanie atrybutów zainteresowania na obrazie, takich jak rysy twarzy), ocena pozy czy humoru, estymacja siatki 3D i tak dalej. Ale na początek klasyfikacja obrazów, segmentacja obrazów i wykrywanie obiektów stanowią podstawę, z którą powinniśmy poznać. Większość zastosowań wizji komputerowej sprowadza się do jednego z tych trzech zadań.</p>

<div class="no-row-height column-margin column-container"><div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://pcl.sitehost.iu.edu/rgoldsto/projects/segmentation.jpg" class="img-fluid figure-img" width="400"></p>
</figure>
</div></div><p>Segmentacja obrazu z głębokim uczeniem polega na użyciu modelu do przypisania klasy do każdego piksela w obrazie, a tym samym segmentacji obrazu na różne strefy (takie jak “tło” i “pierwszy plan” lub “droga”, “samochód” i “chodnik”). Ta ogólna kategoria technik może być wykorzystana do zasilania znacznej liczby cennych aplikacji w edycji obrazu i wideo, autonomicznej jazdy, robotyki, obrazowania medycznego, itp. Istnieją dwa różne rodzaje segmentacji obrazu, o których powinniśmy wiedzieć:</p>
<ul>
<li>Segmentacja semantyczna, gdzie każdy piksel jest niezależnie klasyfikowany do kategorii semantycznej, jak “kot”. Jeśli na obrazie są dwa koty, to wszystkie odpowiadające im piksele są mapowane do tej samej ogólnej kategorii “kot” (patrz <a href="#fig-seg2">Rysunek&nbsp;<span>14.2</span></a>).</li>
<li>Segmentacja instancji, która ma na celu nie tylko klasyfikację pikseli obrazu według kategorii, ale także wyodrębnienie poszczególnych instancji obiektu. W przypadku obrazu z dwoma kotami segmentacja instancji traktowałaby “kot 1” i “kot 2” jako dwie oddzielne klasy pikseli (patrz <a href="#fig-seg2">Rysunek&nbsp;<span>14.2</span></a>).</li>
</ul>
<p>W tym przykładzie skupimy się na segmentacji semantycznej: ponownie przyjrzymy się obrazom kotów i psów, i tym razem nauczymy się, jak odróżnić główny obiekt od jego tła.</p>
<div id="fig-seg2" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="images/Zrzut ekranu 2023-03-18 o 10.35.38.png" class="img-fluid figure-img" width="600"></p>
<p></p><figcaption class="figure-caption">Rysunek&nbsp;14.2: Przykłady segmentacji</figcaption><p></p>
</figure>
</div>
<p>Będziemy pracować z zestawem danych Oxford-IIIT Pets (<a href="http://www.robots.ox.ac.uk/~vgg/data/pets/" class="uri">http://www.robots.ox.ac.uk/~vgg/data/pets/</a>), który zawiera 7390 zdjęć różnych ras kotów i psów, wraz z maskami segmentacji pierwszego planu i tła dla każdego zdjęcia. Maska segmentacyjna jest odpowiednikiem etykiety: jest to obraz o tym samym rozmiarze co obraz wejściowy, z jednym kanałem koloru, gdzie każda wartość całkowita odpowiada klasie odpowiadającego jej piksela na obrazie wejściowym. W naszym przypadku piksele masek segmentacyjnych mogą przyjmować jedną z trzech wartości całkowitych:</p>
<ol type="1">
<li>pierwszy plan</li>
<li>tło</li>
<li>kontur</li>
</ol>
<div class="cell">
<details open="">
<summary>Kod</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># eval: false</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(fs)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>data_dir <span class="ot">&lt;-</span> <span class="fu">path</span>(<span class="st">"/Users/majerek/Downloads/pets_dataset"</span>)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">dir_create</span>(data_dir)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>data_url <span class="ot">&lt;-</span> <span class="fu">path</span>(<span class="st">"http://www.robots.ox.ac.uk/~vgg/data/pets/data"</span>) </span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (filename <span class="cf">in</span> <span class="fu">c</span>(<span class="st">"images.tar.gz"</span>, <span class="st">"annotations.tar.gz"</span>)) {</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># uncomment for the first time</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a> <span class="co"># download.file(url = data_url / filename,</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a> <span class="co">#             destfile = data_dir / filename)</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a> <span class="co"># untar(data_dir / filename, exdir = data_dir)</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Kopiuj do schowka" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Obrazy wejściowe zapisywane są jako pliki JPG w folderze <code>images/</code> (np. <code>images/Abyssinian_1.jpg</code>), a odpowiadająca im maska segmentacyjna zapisywana jest jako plik PNG o tej samej nazwie w folderze <code>annotations/trimaps/</code> (np. <code>annotations/trimaps/Abyssinian_1.png</code>). Przygotujmy ramki danych (technicznie rzecz biorąc, <code>tibble</code>) z kolumnami dla naszych ścieżek do plików wejściowych, a także listę odpowiadających im ścieżek do plików maski:</p>
<div class="cell">
<details open="">
<summary>Kod</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>input_dir <span class="ot">&lt;-</span> data_dir <span class="sc">/</span> <span class="st">"images"</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>target_dir <span class="ot">&lt;-</span> data_dir <span class="sc">/</span> <span class="st">"annotations/trimaps/"</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>image_paths <span class="ot">&lt;-</span> tibble<span class="sc">::</span><span class="fu">tibble</span>(</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a> <span class="at">input =</span> <span class="fu">sort</span>(<span class="fu">dir_ls</span>(input_dir, <span class="at">glob =</span> <span class="st">"*.jpg"</span>)),</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a> <span class="at">target =</span> <span class="fu">sort</span>(<span class="fu">dir_ls</span>(target_dir, <span class="at">glob =</span> <span class="st">"*.png"</span>)))</span></code><button title="Kopiuj do schowka" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Aby mieć pewność, że dopasujemy obraz do właściwego celu, posortujemy obie listy. Wektory ścieżek sortują się tak samo, ponieważ cele i ścieżki obrazów mają tę samą bazową nazwę pliku. Następnie, aby pomóc nam śledzić ścieżki i upewnić się, że nasze wektory wejściowe i docelowe pozostają zsynchronizowane, łączymy je w dwukolumnową ramkę danych (używamy <code>tibble()</code>, aby stworzyć ramkę danych):</p>
<div class="cell">
<details open="">
<summary>Kod</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>tibble<span class="sc">::</span><span class="fu">glimpse</span>(image_paths)</span></code><button title="Kopiuj do schowka" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 7,390
Columns: 2
$ input  &lt;fs::path&gt; "/Users/majerek/Downloads/pets_dataset/images/Abyssinian_1…
$ target &lt;fs::path&gt; "/Users/majerek/Downloads/pets_dataset/annotations/trimaps…</code></pre>
</div>
</div>
<p>Jak wygląda jedno z tych wejść i jego maska? Najpierw zdefiniujemy funkcję pomocniczą, która wykreśli tensor TensorFlow zawierający obraz przy użyciu funkcji <code>plot()</code> programu R:</p>
<div class="cell">
<details open="">
<summary>Kod</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>display_image_tensor <span class="ot">&lt;-</span> <span class="cf">function</span>(x, ..., <span class="at">max =</span> <span class="dv">255</span>,</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">plot_margins =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>)) {   </span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(plot_margins))</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">par</span>(<span class="at">mar =</span> plot_margins)</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>  x <span class="sc">|&gt;</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as.array</span>() <span class="sc">|&gt;</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">drop</span>() <span class="sc">|&gt;</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as.raster</span>(<span class="at">max =</span> max) <span class="sc">|&gt;</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">plot</span>(..., <span class="at">interpolate =</span> <span class="cn">FALSE</span>)</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Kopiuj do schowka" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>W wywołaniu <code>as.raster()</code> ustawiamy <code>max = 255</code>, ponieważ podobnie jak w przypadku MNIST, obrazy są zakodowane jako <code>uint8</code>.</p>
<div class="cell">
<details open="">
<summary>Kod</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tensorflow)</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>image_tensor <span class="ot">&lt;-</span> image_paths<span class="sc">$</span>input[<span class="dv">10</span>] <span class="sc">|&gt;</span> </span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>   tf<span class="sc">$</span>io<span class="sc">$</span><span class="fu">read_file</span>() <span class="sc">|&gt;</span> </span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>   tf<span class="sc">$</span>io<span class="sc">$</span><span class="fu">decode_jpeg</span>()</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(image_tensor)</span></code><button title="Kopiuj do schowka" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;tf.Tensor: shape=(448, 500, 3), dtype=uint8, numpy=…&gt;</code></pre>
</div>
<details open="">
<summary>Kod</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">display_image_tensor</span>(image_tensor)</span></code><button title="Kopiuj do schowka" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-seg3" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="segmentation_files/figure-html/fig-seg3-1.png" class="img-fluid figure-img" width="672"></p>
<p></p><figcaption class="figure-caption">Rysunek&nbsp;14.3: Przykładowy obraz z bazy</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>Zdefiniujemy również funkcję do wyświetlania obrazu docelowego. Obraz docelowy jest również odczytywany jako <code>uint8</code>, ale tym razem w tensorze obrazu docelowego znajdują się tylko wartości (1, 2, 3). Aby go wykreślić, odejmujemy 1, aby etykiety miały zakres od 0 do 2, a następnie ustawiamy <code>max = 2</code>, aby etykiety miały wartości 0 (czarny), 1 (szary) i 2 (biały).</p>
<div class="cell">
<details open="">
<summary>Kod</summary>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>display_target_tensor <span class="ot">&lt;-</span> <span class="cf">function</span>(target) <span class="fu">display_image_tensor</span>(target <span class="sc">-</span> <span class="dv">1</span>, <span class="at">max =</span> <span class="dv">2</span>)   </span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>target <span class="ot">&lt;-</span> image_paths<span class="sc">$</span>target[<span class="dv">10</span>] <span class="sc">|&gt;</span> </span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>   tf<span class="sc">$</span>io<span class="sc">$</span><span class="fu">read_file</span>() <span class="sc">|&gt;</span> </span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>   tf<span class="sc">$</span>io<span class="sc">$</span><span class="fu">decode_png</span>()</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(target)</span></code><button title="Kopiuj do schowka" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;tf.Tensor: shape=(448, 500, 1), dtype=uint8, numpy=…&gt;</code></pre>
</div>
<details open="">
<summary>Kod</summary>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">display_target_tensor</span>(target)</span></code><button title="Kopiuj do schowka" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-seg4" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="segmentation_files/figure-html/fig-seg4-1.png" class="img-fluid figure-img" width="672"></p>
<p></p><figcaption class="figure-caption">Rysunek&nbsp;14.4: Przykładowa maska</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>Następnie załadujmy nasze wejścia i cele do dwóch TF Datasets i podzielmy pliki na zestawy treningowe i walidacyjne. Ponieważ zbiór danych jest bardzo mały, możemy po prostu załadować wszystko do pamięci:</p>
<div class="cell">
<details open="">
<summary>Kod</summary>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tfdatasets)</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>tf_read_image <span class="ot">&lt;-</span> <span class="cf">function</span>(path, <span class="at">format =</span> <span class="st">"image"</span>, <span class="at">resize =</span> <span class="cn">NULL</span>, ...) {</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>  img <span class="ot">&lt;-</span> path <span class="sc">|&gt;</span> </span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>    tf<span class="sc">$</span>io<span class="sc">$</span><span class="fu">read_file</span>()  <span class="sc">|&gt;</span> </span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>    tf<span class="sc">$</span>io[[<span class="fu">paste0</span>(<span class="st">"decode_"</span>, format)]](...)</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(resize)) {</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>    img <span class="ot">&lt;-</span> img <span class="sc">|&gt;</span> </span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>      tf<span class="sc">$</span>image<span class="sc">$</span><span class="fu">resize</span>(<span class="fu">as.integer</span>(resize))</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>  img</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>img_size <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">200</span>, <span class="dv">200</span>)</span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>tf_read_image_and_resize <span class="ot">&lt;-</span> <span class="cf">function</span>(..., <span class="at">resize =</span> img_size) {</span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tf_read_image</span>(..., <span class="at">resize =</span> resize)</span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a>make_dataset <span class="ot">&lt;-</span> <span class="cf">function</span>(paths_df) {</span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tensor_slices_dataset</span>(paths_df) <span class="sc">|&gt;</span> </span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a>    <span class="fu">dataset_map</span>(<span class="cf">function</span>(path) {</span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a>      image <span class="ot">&lt;-</span> path<span class="sc">$</span>input <span class="sc">|&gt;</span> </span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a>        <span class="fu">tf_read_image_and_resize</span>(<span class="st">"jpeg"</span>, <span class="at">channels =</span> 3L)</span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a>      target <span class="ot">&lt;-</span> path<span class="sc">$</span>target <span class="sc">|&gt;</span> </span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true" tabindex="-1"></a>        <span class="fu">tf_read_image_and_resize</span>(<span class="st">"png"</span>, <span class="at">channels =</span> 1L)</span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true" tabindex="-1"></a>      target <span class="ot">&lt;-</span> target <span class="sc">-</span> <span class="dv">1</span></span>
<span id="cb12-29"><a href="#cb12-29" aria-hidden="true" tabindex="-1"></a>      <span class="fu">list</span>(image, target)</span>
<span id="cb12-30"><a href="#cb12-30" aria-hidden="true" tabindex="-1"></a>    }) <span class="sc">|&gt;</span> </span>
<span id="cb12-31"><a href="#cb12-31" aria-hidden="true" tabindex="-1"></a>    <span class="fu">dataset_cache</span>() <span class="sc">|&gt;</span> </span>
<span id="cb12-32"><a href="#cb12-32" aria-hidden="true" tabindex="-1"></a>    <span class="fu">dataset_shuffle</span>(<span class="at">buffer_size =</span> <span class="fu">nrow</span>(paths_df)) <span class="sc">|&gt;</span></span>
<span id="cb12-33"><a href="#cb12-33" aria-hidden="true" tabindex="-1"></a>    <span class="fu">dataset_batch</span>(<span class="dv">32</span>)</span>
<span id="cb12-34"><a href="#cb12-34" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb12-35"><a href="#cb12-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-36"><a href="#cb12-36" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">44</span>)</span>
<span id="cb12-37"><a href="#cb12-37" aria-hidden="true" tabindex="-1"></a>num_val_samples <span class="ot">&lt;-</span> <span class="dv">1000</span></span>
<span id="cb12-38"><a href="#cb12-38" aria-hidden="true" tabindex="-1"></a>val_idx <span class="ot">&lt;-</span> <span class="fu">sample.int</span>(<span class="fu">nrow</span>(image_paths), num_val_samples)</span>
<span id="cb12-39"><a href="#cb12-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-40"><a href="#cb12-40" aria-hidden="true" tabindex="-1"></a>val_paths <span class="ot">&lt;-</span> image_paths[val_idx, ]</span>
<span id="cb12-41"><a href="#cb12-41" aria-hidden="true" tabindex="-1"></a>train_paths <span class="ot">&lt;-</span> image_paths[<span class="sc">-</span>val_idx, ]</span>
<span id="cb12-42"><a href="#cb12-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-43"><a href="#cb12-43" aria-hidden="true" tabindex="-1"></a>validation_dataset <span class="ot">&lt;-</span> <span class="fu">make_dataset</span>(val_paths)</span>
<span id="cb12-44"><a href="#cb12-44" aria-hidden="true" tabindex="-1"></a>train_dataset <span class="ot">&lt;-</span> <span class="fu">make_dataset</span>(train_paths)</span></code><button title="Kopiuj do schowka" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Teraz zdefiniujemy model:</p>
<div class="cell">
<details open="">
<summary>Kod</summary>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(keras)</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>get_model <span class="ot">&lt;-</span> <span class="cf">function</span>(img_size, num_classes) {</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>  conv <span class="ot">&lt;-</span> <span class="cf">function</span>(..., <span class="at">padding =</span> <span class="st">"same"</span>, <span class="at">activation =</span> <span class="st">"relu"</span>) { </span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">layer_conv_2d</span>(..., <span class="at">padding =</span> padding, <span class="at">activation =</span> activation)</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>  conv_transpose <span class="ot">&lt;-</span> <span class="cf">function</span>(..., <span class="at">padding =</span> <span class="st">"same"</span>, <span class="at">activation =</span> <span class="st">"relu"</span>) { </span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">layer_conv_2d_transpose</span>(..., <span class="at">padding =</span> padding, <span class="at">activation =</span> activation)</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>  input <span class="ot">&lt;-</span> <span class="fu">layer_input</span>(<span class="at">shape =</span> <span class="fu">c</span>(img_size, <span class="dv">3</span>))</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>  output <span class="ot">&lt;-</span> input <span class="sc">|&gt;</span></span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">layer_rescaling</span>(<span class="at">scale =</span> <span class="dv">1</span> <span class="sc">/</span> <span class="dv">255</span>) <span class="sc">|&gt;</span></span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">conv</span>(<span class="dv">64</span>, <span class="dv">3</span>, <span class="at">strides =</span> <span class="dv">2</span>) <span class="sc">|&gt;</span></span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">conv</span>(<span class="dv">64</span>, <span class="dv">3</span>) <span class="sc">|&gt;</span></span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">conv</span>(<span class="dv">128</span>, <span class="dv">3</span>, <span class="at">strides =</span> <span class="dv">2</span>) <span class="sc">|&gt;</span></span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">conv</span>(<span class="dv">128</span>, <span class="dv">3</span>) <span class="sc">|&gt;</span></span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">conv</span>(<span class="dv">256</span>, <span class="dv">3</span>, <span class="at">strides =</span> <span class="dv">2</span>) <span class="sc">|&gt;</span></span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">conv</span>(<span class="dv">256</span>, <span class="dv">3</span>) <span class="sc">|&gt;</span></span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">conv_transpose</span>(<span class="dv">256</span>, <span class="dv">3</span>) <span class="sc">|&gt;</span></span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">conv_transpose</span>(<span class="dv">256</span>, <span class="dv">3</span>, <span class="at">strides =</span> <span class="dv">2</span>) <span class="sc">|&gt;</span></span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">conv_transpose</span>(<span class="dv">128</span>, <span class="dv">3</span>) <span class="sc">|&gt;</span></span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a>    <span class="fu">conv_transpose</span>(<span class="dv">128</span>, <span class="dv">3</span>, <span class="at">strides =</span> <span class="dv">2</span>) <span class="sc">|&gt;</span></span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">conv_transpose</span>(<span class="dv">64</span>, <span class="dv">3</span>) <span class="sc">|&gt;</span></span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true" tabindex="-1"></a>    <span class="fu">conv_transpose</span>(<span class="dv">64</span>, <span class="dv">3</span>, <span class="at">strides =</span> <span class="dv">2</span>) <span class="sc">|&gt;</span></span>
<span id="cb13-26"><a href="#cb13-26" aria-hidden="true" tabindex="-1"></a>    <span class="fu">conv</span>(num_classes, <span class="dv">3</span>, <span class="at">activation =</span> <span class="st">"softmax"</span>)</span>
<span id="cb13-27"><a href="#cb13-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-28"><a href="#cb13-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">keras_model</span>(input, output)</span>
<span id="cb13-29"><a href="#cb13-29" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb13-30"><a href="#cb13-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-31"><a href="#cb13-31" aria-hidden="true" tabindex="-1"></a>model <span class="ot">&lt;-</span> <span class="fu">get_model</span>(<span class="at">img_size =</span> img_size, <span class="at">num_classes =</span> <span class="dv">3</span>)</span>
<span id="cb13-32"><a href="#cb13-32" aria-hidden="true" tabindex="-1"></a>model</span></code><button title="Kopiuj do schowka" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Model: "model"
________________________________________________________________________________
 Layer (type)                       Output Shape                    Param #     
================================================================================
 input_1 (InputLayer)               [(None, 200, 200, 3)]           0           
 rescaling (Rescaling)              (None, 200, 200, 3)             0           
 conv2d_6 (Conv2D)                  (None, 100, 100, 64)            1792        
 conv2d_5 (Conv2D)                  (None, 100, 100, 64)            36928       
 conv2d_4 (Conv2D)                  (None, 50, 50, 128)             73856       
 conv2d_3 (Conv2D)                  (None, 50, 50, 128)             147584      
 conv2d_2 (Conv2D)                  (None, 25, 25, 256)             295168      
 conv2d_1 (Conv2D)                  (None, 25, 25, 256)             590080      
 conv2d_transpose_5 (Conv2DTranspos  (None, 25, 25, 256)            590080      
 e)                                                                             
 conv2d_transpose_4 (Conv2DTranspos  (None, 50, 50, 256)            590080      
 e)                                                                             
 conv2d_transpose_3 (Conv2DTranspos  (None, 50, 50, 128)            295040      
 e)                                                                             
 conv2d_transpose_2 (Conv2DTranspos  (None, 100, 100, 128)          147584      
 e)                                                                             
 conv2d_transpose_1 (Conv2DTranspos  (None, 100, 100, 64)           73792       
 e)                                                                             
 conv2d_transpose (Conv2DTranspose)  (None, 200, 200, 64)           36928       
 conv2d (Conv2D)                    (None, 200, 200, 3)             1731        
================================================================================
Total params: 2,880,643
Trainable params: 2,880,643
Non-trainable params: 0
________________________________________________________________________________</code></pre>
</div>
</div>
<p>Pierwsza połowa modelu bardzo przypomina sieć splotową używaną do klasyfikacji obrazów: stos warstw <code>Conv2D</code> ze stopniowo zwiększającymi się rozmiarami filtrów. Obniżamy próbkowanie naszych obrazów dwukrotnie aż trzy razy, kończąc na aktywacjach o rozmiarze <code>(25, 25, 256)</code>. Celem tej pierwszej połowy jest zakodowanie obrazów w mniejsze mapy cech, gdzie każde miejsce przestrzenne (lub piksel) zawiera informację o dużym przestrzennym kawałku oryginalnego obrazu. Można to rozumieć jako rodzaj kompresji.</p>
<p>Jedną z ważnych różnic pomiędzy pierwszą połową tego modelu a modelami klasyfikacyjnymi, które widziałeś wcześniej, jest sposób, w jaki dokonujemy <em>downsamplingu</em>: w sieciach splotowych klasyfikacyjnych z wcześniejszego rozdziału używaliśmy warstw <code>MaxPooling2D</code> do <em>downsamplingu</em> map cech. W tym przypadku <em>downsamplingu</em> dokonujemy poprzez dodanie <em>strides</em> do każdej kolejnej warstwy konwolucji. Robimy to, ponieważ w przypadku segmentacji obrazu bardzo zależy nam na przestrzennej lokalizacji informacji w obrazie, ponieważ musimy wyprodukować docelowe maski pikselowe jako wyjście modelu. Kiedy wykonujemy <em>max pooling</em> 2 × 2, całkowicie niszczymy informacje o lokalizacji w każdym oknie <em>poolingu</em>: zwracamy jedną wartość na okno, z zerową wiedzą o tym, z której z czterech lokalizacji pochodzi ta wartość. Tak więc, mimo że warstwy <em>max pooling</em> dobrze sprawdzają się w zadaniach klasyfikacji, to w przypadku zadania segmentacji nie są tak skuteczne. W międzyczasie, konwolucje paskowe (<em>strides</em>) lepiej radzą sobie z <em>downsamplingiem</em> map cech, zachowując jednocześnie informacje o lokalizacji.</p>

<div class="no-row-height column-margin column-container"><div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://media.giphy.com/media/glmRyiSI3v5E4/giphy-downsized-large.gif" class="img-fluid figure-img" width="400"></p>
</figure>
</div></div><p>Druga połowa modelu to stos warstw <code>Conv2DTranspose</code>. Co to jest? Cóż, wyjściem pierwszej połowy modelu jest mapa cech o kształcie <code>(25, 25, 256)</code>, ale chcemy, aby nasze ostateczne wyjście miało taki sam kształt jak maski docelowe, <code>(200, 200, 3).</code> W związku z tym musimy zastosować coś w rodzaju odwrotności dotychczasowych przekształceń - coś, co spowoduje zwiększenie próbkowania map funkcji zamiast ich zmniejszenia. Jest to cel warstwy <code>Conv2DTranspose</code>: można o niej myśleć jak o warstwie konwolucji, która uczy się zwiększać próbkowanie. Jeśli mamy wejście o kształcie <code>(100, 100, 64)</code> i przepuścimy je przez warstwę <code>layer_conv_2d(128, 3, strides = 2, padding = "same")</code>, otrzymamy wyjście o kształcie <code>(50, 50, 128)</code>. Jeśli przepuścimy to wyjście przez warstwę <code>layer_conv_2d_transpose(64, 3, strides = 2, padding = "same")</code>, otrzymamy z powrotem wyjście o kształcie <code>(100, 100, 64)</code>, takie samo jak oryginał. Tak więc po skompresowaniu naszych danych wejściowych do map funkcji o kształcie <code>(25, 25, 256)</code> poprzez stos warstw <code>Conv2D</code>, możemy po prostu zastosować odpowiednią sekwencję warstw <code>Conv2DTranspose</code>, aby uzyskać z powrotem obrazy o kształcie <code>(200, 200, 3)</code>.</p>
<p>Możemy teraz skompilować i dopasować nasz model:</p>
<div class="cell">
<details open="">
<summary>Kod</summary>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>model <span class="sc">|&gt;</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a> <span class="fu">compile</span>(<span class="at">optimizer =</span> <span class="st">"rmsprop"</span>,</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>         <span class="at">loss =</span> <span class="st">"sparse_categorical_crossentropy"</span>)   </span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>callbacks <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a> <span class="fu">callback_model_checkpoint</span>(<span class="st">"models/oxford_segmentation.keras"</span>,</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>                             <span class="at">save_best_only =</span> <span class="cn">TRUE</span>))</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>history <span class="ot">&lt;-</span> model <span class="sc">|&gt;</span> <span class="fu">fit</span>(</span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a> train_dataset,</span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a> <span class="at">epochs =</span> <span class="dv">50</span>,</span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a> <span class="at">callbacks =</span> callbacks,</span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a> <span class="at">validation_data =</span> validation_dataset</span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Kopiuj do schowka" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Podczas treningu możesz zobaczyć ostrzeżenie takie jak <code>Corrupt JPEG data: premature end of data segment</code>. To dlatego, że zbiór danych nie jest perfekcyjnie przygotowany.</p>
<div class="cell">
<details open="">
<summary>Kod</summary>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>model <span class="ot">&lt;-</span> <span class="fu">load_model_tf</span>(<span class="st">"models/oxford_segmentation.keras"</span>)</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"models/oxford_seg_hist.rda"</span>)</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(history)</span></code><button title="Kopiuj do schowka" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="segmentation_files/figure-html/unnamed-chunk-10-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Widać, że w połowie drogi, około epoki 25, model zaczyna się nadmiernie dopasowywać.</p>
<div class="cell">
<details open="">
<summary>Kod</summary>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>test_image <span class="ot">&lt;-</span> val_paths<span class="sc">$</span>input[<span class="dv">4</span>] <span class="sc">|&gt;</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tf_read_image_and_resize</span>(<span class="st">"jpeg"</span>, <span class="at">channels =</span> 3L)</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>predicted_mask_probs <span class="ot">&lt;-</span> </span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">model</span>(test_image[tf<span class="sc">$</span>newaxis, , , ])</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>predicted_mask <span class="ot">&lt;-</span> </span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>  tf<span class="sc">$</span><span class="fu">argmax</span>(predicted_mask_probs, <span class="at">axis =</span> <span class="sc">-</span>1L)</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>predicted_target <span class="ot">&lt;-</span> predicted_mask <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>))</span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a><span class="fu">display_image_tensor</span>(test_image)</span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a><span class="fu">display_target_tensor</span>(predicted_target)</span></code><button title="Kopiuj do schowka" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-seg5" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="segmentation_files/figure-html/fig-seg5-1.png" class="img-fluid figure-img" width="672"></p>
<p></p><figcaption class="figure-caption">Rysunek&nbsp;14.5: Obraz testowy i jego przewidywana maska segmentacyjna</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>Jest kilka małych artefaktów w naszej przewidywanej masce. Niemniej jednak nasz model wydaje się działać poprawnie.</p>
<section id="nowoczesne-architektury-sieci-splotowych" class="level2 page-columns page-full" data-number="14.1">
<h2 data-number="14.1" class="anchored" data-anchor-id="nowoczesne-architektury-sieci-splotowych"><span class="header-section-number">14.1</span> Nowoczesne architektury sieci splotowych</h2>
<p>Architektura modelu jest sumą wyborów, które zostały dokonane przy jego tworzeniu: jakich warstw użyć, jak je skonfigurować i w jakim układzie je połączyć. Te wybory definiują przestrzeń hipotez twojego modelu: przestrzeń możliwych funkcji, które mogą być przeszukiwane przez spadek gradientu, parametryzowane przez wagi modelu. Podobnie jak w przypadku inżynierii cech, dobra przestrzeń hipotez koduje wcześniejszą wiedzę, którą posiadamy na temat danego problemu i jego rozwiązania. Na przykład, użycie warstw konwolucji oznacza, że z góry wiemy, że istotne wzory obecne na obrazach wejściowych są niezmienne względem translacji. Aby skutecznie uczyć się z danych, musimy przyjąć założenia dotyczące tego, czego szukamy.</p>
<p>Jeśli dokonamy niewłaściwego wyboru architektury, nasz model może utknąć z nieoptymalnymi metrykami i żadna ilość danych treningowych go nie uratuje. I odwrotnie, dobra architektura modelu przyspieszy uczenie i umożliwi efektywne wykorzystanie dostępnych danych treningowych, zmniejszając zapotrzebowanie na duże zbiory danych. Dobra architektura modelu to taka, która zmniejsza rozmiar przestrzeni wyszukiwania lub w inny sposób ułatwia konwergencję do dobrego punktu przestrzeni wyszukiwania. Podobnie jak w przypadku inżynierii cech, architektura modelu polega na uproszczeniu problemu do rozwiązania przez spadek gradientu.</p>

<div class="no-row-height column-margin column-container"><div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://media.giphy.com/media/Fkmgse8OMKn9C/giphy.gif" class="img-fluid figure-img"></p>
</figure>
</div></div><p>Architektura modelu jest bardziej sztuką niż nauką. Doświadczeni inżynierowie uczenia maszynowego są w stanie intuicyjnie poskładać wydajne modele przy pierwszej próbie, podczas gdy początkujący często mają problemy ze stworzeniem modelu, który w ogóle się uczy. Kluczowym słowem jest tu intuicja: nikt nie jest w stanie podać jasnego wyjaśnienia, co działa, a co nie. Eksperci polegają na kojarzeniu wzorców, umiejętności, którą nabywają poprzez bogate doświadczenie praktyczne.</p>
<p>W dalszej części omówimy kilka podstawowych praktyk architektury sieci konwolucyjnych: w szczególności połączenia resztkowe (ang. <em>residual connection</em>), normalizację partii (ang. <em>batch normalization</em>) i konwolucje separowalne (ang. <em>separable convolutions</em>).</p>
<p>Większość sieci splotowych często charakteryzuje się strukturami przypominającymi piramidy (hierarchie cech). Przypomnij sobie na przykład progresję w liczbie filtrów konwolucyjnych, których użyliśmy w pierwszej sieci splotowej: 32, 64, 128. Liczba filtrów rośnie wraz z głębokością warstw, podczas gdy rozmiar map cech odpowiednio się kurczy. Ten sam wzór zauważymy w blokach modelu VGG16 (patrz <a href="#fig-seg6">Rysunek&nbsp;<span>14.6</span></a>).</p>
<div id="fig-seg6" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="images/Zrzut ekranu 2023-03-18 o 14.10.24.png" class="img-fluid figure-img" width="600"></p>
<p></p><figcaption class="figure-caption">Rysunek&nbsp;14.6: Architektura sieci VGG16</figcaption><p></p>
</figure>
</div>
<p>Ogólnie rzecz biorąc, głęboki stos wąskich warstw działa lepiej niż płytki stos dużych warstw. Istnieje jednak pewne ograniczenie, jak głęboko można układać warstwy, a wiąże się z problem znikających gradientów. To prowadzi nas do naszego pierwszego istotnego wzorca architektury modelu: połączeń resztkowych.</p>
<section id="połączenia-rezydualne" class="level3 page-columns page-full" data-number="14.1.1">
<h3 data-number="14.1.1" class="anchored" data-anchor-id="połączenia-rezydualne"><span class="header-section-number">14.1.1</span> Połączenia rezydualne</h3>
<p>Wsteczna propagacja używania do uczenia modeli głębokich przypomina grę w “głuchy telefon”, gdzie kolejne osoby szepczą sobie do ucha przekazując pewną - wymyśloną przez pierwszego gracza - informację. Po kilku przejściach informacja ta jest znacznie zniekształcona. Podobnie jest w uczeniu sieci, gdzie propagacją błędów wstecz powoduje wprowadzenie pewnych błędów w kolejnych warstwach sieci. Każda kolejna funkcja w łańcuchu wprowadza pewną ilość szumu. Jeśli łańcuch funkcji jest zbyt głęboki, szum ten zaczyna przytłaczać informacje o gradiencie i wsteczna propagacja przestaje działać. Jest to problem znikających gradientów.</p>
<p>Rozwiązanie jest proste: wystarczy wymusić, aby każda funkcja w łańcuchu była nieniszcząca - zachowywała “czystą” wersję informacji zawartej w poprzednim wejściu. Najłatwiejszym sposobem wdrożenia tego jest użycie połączenia rezydualnego.</p>

<div class="no-row-height column-margin column-container"><div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://media.giphy.com/media/OYnjptyYk6Lny/giphy.gif" class="img-fluid figure-img"></p>
</figure>
</div></div><p>Jest to bardzo proste: wystarczy dodać wejście warstwy lub bloku warstw z powrotem do jej wyjścia (patrz <a href="#fig-seg7">Rysunek&nbsp;<span>14.7</span></a>). Połączenie rezydualne działa jak skrót informacyjny wokół destrukcyjnych lub zaszumiających bloków (takich jak bloki zawierające aktywacje <code>relu</code> lub warstwy <code>dropout</code>), przekazując informację o gradiencie błędu z wczesnych warstw, tak aby propagować przez głęboką sieć. Technika ta została wprowadzona w 2015 roku wraz z rodziną modeli <em>ResNet</em> (opracowanych przez <span class="citation" data-cites="heDeepResidualLearning2015">He i in. (<a href="references.html#ref-heDeepResidualLearning2015" role="doc-biblioref">2015</a>)</span>).</p>
<div id="fig-seg7" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="images/Zrzut ekranu 2023-03-18 o 14.23.47.png" class="img-fluid figure-img" width="600"></p>
<p></p><figcaption class="figure-caption">Rysunek&nbsp;14.7: Połączenie rezydualne</figcaption><p></p>
</figure>
</div>
<p>Zauważmy, że dodanie wejścia z powrotem do wyjścia bloku sugeruje, że wyjście powinno mieć taki sam kształt jak wejście. Jednak tak nie jest, jeśli nasz blok zawiera warstwy konwolucyjne ze zwiększoną liczbą filtrów lub warstwę <em>max-pooling</em>. W takich przypadkach używamy warstwy 1x1 <code>layer_conv_2d()</code> bez aktywacji, aby liniowo rzutować resztę na pożądany kształt wyjścia. Zazwyczaj używamy <code>paddingu = "same"</code> w warstwach konwolucji w bloku docelowym, aby uniknąć przestrzennego <em>downsamplingu</em> spowodowanego <em>paddingiem</em>, a w projekcji resztkowej używamy <em>strides</em>.</p>
<div class="cell">
<details open="">
<summary>Kod</summary>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co"># klasyczne podejście</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>inputs <span class="ot">&lt;-</span> <span class="fu">layer_input</span>(<span class="at">shape =</span> <span class="fu">c</span>(<span class="dv">32</span>, <span class="dv">32</span>, <span class="dv">3</span>))</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> inputs <span class="sc">|&gt;</span> <span class="fu">layer_conv_2d</span>(<span class="dv">32</span>, <span class="dv">3</span>, <span class="at">activation =</span> <span class="st">"relu"</span>)</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>residual <span class="ot">&lt;-</span> x</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> x <span class="sc">|&gt;</span> <span class="fu">layer_conv_2d</span>(<span class="dv">64</span>, <span class="dv">3</span>, <span class="at">activation =</span> <span class="st">"relu"</span>, <span class="at">padding =</span> <span class="st">"same"</span>)</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>residual <span class="ot">&lt;-</span> residual <span class="sc">|&gt;</span> <span class="fu">layer_conv_2d</span>(<span class="dv">64</span>, <span class="dv">1</span>)</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">layer_add</span>(<span class="fu">c</span>(x, residual))</span></code><button title="Kopiuj do schowka" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details open="">
<summary>Kod</summary>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># podejście wykorzystujące stride</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>inputs <span class="ot">&lt;-</span> <span class="fu">layer_input</span>(<span class="at">shape =</span> <span class="fu">c</span>(<span class="dv">32</span>, <span class="dv">32</span>, <span class="dv">3</span>))</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> inputs <span class="sc">|&gt;</span> <span class="fu">layer_conv_2d</span>(<span class="dv">32</span>, <span class="dv">3</span>, <span class="at">activation =</span> <span class="st">"relu"</span>)</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>residual <span class="ot">&lt;-</span> x</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> x <span class="sc">|&gt;</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">layer_conv_2d</span>(<span class="dv">64</span>, <span class="dv">3</span>, <span class="at">activation =</span> <span class="st">"relu"</span>, <span class="at">padding =</span> <span class="st">"same"</span>) <span class="sc">|&gt;</span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">layer_max_pooling_2d</span>(<span class="dv">2</span>, <span class="at">padding =</span> <span class="st">"same"</span>)</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>residual <span class="ot">&lt;-</span> residual <span class="sc">|&gt;</span></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">layer_conv_2d</span>(<span class="dv">64</span>, <span class="dv">1</span>, <span class="at">strides =</span> <span class="dv">2</span>)</span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">layer_add</span>(<span class="fu">list</span>(x, residual))</span></code><button title="Kopiuj do schowka" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Aby uczynić te pomysły bardziej konkretnymi, oto przykład prostej sieci splotowej zorganizowanej w serię bloków, z których każdy składa się z dwóch warstw konwolucji i jednej opcjonalnej warstwy <em>max-pooling</em>, z połączeniem rezydualnym wokół każdego bloku:</p>
<div class="cell">
<details open="">
<summary>Kod</summary>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>inputs <span class="ot">&lt;-</span> <span class="fu">layer_input</span>(<span class="at">shape =</span> <span class="fu">c</span>(<span class="dv">32</span>, <span class="dv">32</span>, <span class="dv">3</span>))</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">layer_rescaling</span>(inputs, <span class="at">scale =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">255</span>)</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>residual_block <span class="ot">&lt;-</span> <span class="cf">function</span>(x, filters, </span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>                           <span class="at">pooling =</span> <span class="cn">FALSE</span>) {</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>  residual <span class="ot">&lt;-</span> x</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> x <span class="sc">|&gt;</span></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">layer_conv_2d</span>(filters, <span class="dv">3</span>, <span class="at">activation =</span> <span class="st">"relu"</span>, <span class="at">padding =</span> <span class="st">"same"</span>) <span class="sc">|&gt;</span></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">layer_conv_2d</span>(filters, <span class="dv">3</span>, <span class="at">activation =</span> <span class="st">"relu"</span>, <span class="at">padding =</span> <span class="st">"same"</span>)</span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (pooling) {</span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>    x <span class="ot">&lt;-</span> x <span class="sc">|&gt;</span> <span class="fu">layer_max_pooling_2d</span>(<span class="at">pool_size =</span> <span class="dv">2</span>, <span class="at">padding =</span> <span class="st">"same"</span>)</span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>    residual <span class="ot">&lt;-</span> residual <span class="sc">|&gt;</span> <span class="fu">layer_conv_2d</span>(filters, <span class="dv">1</span>, <span class="at">strides =</span> <span class="dv">2</span>)</span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (filters <span class="sc">!=</span> <span class="fu">dim</span>(residual)[<span class="dv">4</span>]) {</span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a>    residual <span class="ot">&lt;-</span> residual <span class="sc">|&gt;</span> <span class="fu">layer_conv_2d</span>(filters, <span class="dv">1</span>)</span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">layer_add</span>(<span class="fu">list</span>(x, residual))</span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb20-20"><a href="#cb20-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-21"><a href="#cb20-21" aria-hidden="true" tabindex="-1"></a>outputs <span class="ot">&lt;-</span> x <span class="sc">|&gt;</span></span>
<span id="cb20-22"><a href="#cb20-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">residual_block</span>(<span class="at">filters =</span> <span class="dv">32</span>, <span class="at">pooling =</span> <span class="cn">TRUE</span>) <span class="sc">|&gt;</span></span>
<span id="cb20-23"><a href="#cb20-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">residual_block</span>(<span class="at">filters =</span> <span class="dv">64</span>, <span class="at">pooling =</span> <span class="cn">TRUE</span>) <span class="sc">|&gt;</span></span>
<span id="cb20-24"><a href="#cb20-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">residual_block</span>(<span class="at">filters =</span> <span class="dv">128</span>, <span class="at">pooling =</span> <span class="cn">FALSE</span>) <span class="sc">|&gt;</span></span>
<span id="cb20-25"><a href="#cb20-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">layer_global_average_pooling_2d</span>() <span class="sc">|&gt;</span></span>
<span id="cb20-26"><a href="#cb20-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">layer_dense</span>(<span class="at">units =</span> <span class="dv">1</span>, <span class="at">activation =</span> <span class="st">"sigmoid"</span>)</span>
<span id="cb20-27"><a href="#cb20-27" aria-hidden="true" tabindex="-1"></a>model <span class="ot">&lt;-</span> <span class="fu">keras_model</span>(<span class="at">inputs =</span> inputs, <span class="at">outputs =</span> outputs)</span>
<span id="cb20-28"><a href="#cb20-28" aria-hidden="true" tabindex="-1"></a>model</span></code><button title="Kopiuj do schowka" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Model: "model_1"
________________________________________________________________________________
 Layer (type)             Output Shape      Param #  Connected to               
================================================================================
 input_4 (InputLayer)     [(None, 32, 32,   0        []                         
                          3)]                                                   
 rescaling_1 (Rescaling)  (None, 32, 32, 3  0        ['input_4[0][0]']          
                          )                                                     
 conv2d_14 (Conv2D)       (None, 32, 32, 3  896      ['rescaling_1[0][0]']      
                          2)                                                    
 conv2d_13 (Conv2D)       (None, 32, 32, 3  9248     ['conv2d_14[0][0]']        
                          2)                                                    
 max_pooling2d_1 (MaxPool  (None, 16, 16, 3  0       ['conv2d_13[0][0]']        
 ing2D)                   2)                                                    
 conv2d_15 (Conv2D)       (None, 16, 16, 3  128      ['rescaling_1[0][0]']      
                          2)                                                    
 add_2 (Add)              (None, 16, 16, 3  0        ['max_pooling2d_1[0][0]',  
                          2)                          'conv2d_15[0][0]']        
 conv2d_17 (Conv2D)       (None, 16, 16, 6  18496    ['add_2[0][0]']            
                          4)                                                    
 conv2d_16 (Conv2D)       (None, 16, 16, 6  36928    ['conv2d_17[0][0]']        
                          4)                                                    
 max_pooling2d_2 (MaxPool  (None, 8, 8, 64)  0       ['conv2d_16[0][0]']        
 ing2D)                                                                         
 conv2d_18 (Conv2D)       (None, 8, 8, 64)  2112     ['add_2[0][0]']            
 add_3 (Add)              (None, 8, 8, 64)  0        ['max_pooling2d_2[0][0]',  
                                                      'conv2d_18[0][0]']        
 conv2d_20 (Conv2D)       (None, 8, 8, 128  73856    ['add_3[0][0]']            
                          )                                                     
 conv2d_19 (Conv2D)       (None, 8, 8, 128  147584   ['conv2d_20[0][0]']        
                          )                                                     
 conv2d_21 (Conv2D)       (None, 8, 8, 128  8320     ['add_3[0][0]']            
                          )                                                     
 add_4 (Add)              (None, 8, 8, 128  0        ['conv2d_19[0][0]',        
                          )                           'conv2d_21[0][0]']        
 global_average_pooling2d  (None, 128)      0        ['add_4[0][0]']            
  (GlobalAveragePooling2D                                                       
 )                                                                              
 dense (Dense)            (None, 1)         129      ['global_average_pooling2d[
                                                     0][0]']                    
================================================================================
Total params: 297,697
Trainable params: 297,697
Non-trainable params: 0
________________________________________________________________________________</code></pre>
</div>
</div>
<p>Dzięki połączeniom rezydualnym można budować sieci o dowolnej głębokości, bez konieczności martwienia się o znikające gradienty.</p>
</section>
<section id="normalizacja-partii" class="level3 page-columns page-full" data-number="14.1.2">
<h3 data-number="14.1.2" class="anchored" data-anchor-id="normalizacja-partii"><span class="header-section-number">14.1.2</span> Normalizacja partii</h3>
<p>Normalizacja jest szeroką kategorią metod, które mają na celu uczynienie różnych próbek widzianych przez model uczenia maszynowego bardziej podobnymi do siebie, co pomaga modelowi w uczeniu się i generalizacji na nowych danych. Najbardziej powszechną formą normalizacji danych jest ta, którą już widziałeś kilka razy w tej książce: wyśrodkowanie danych na zero poprzez odjęcie średniej od danych i nadanie danym jednostkowego odchylenia standardowego poprzez podzielenie danych przez ich odchylenie standardowe. W efekcie przyjmuje się założenie, że dane mają rozkład normalny (lub gaussowski) i upewnia się, że rozkład ten jest wyśrodkowany i przeskalowany do jednostkowej wariancji:</p>
<div class="cell">
<details open="">
<summary>Kod</summary>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>normalize_data <span class="ot">&lt;-</span> <span class="fu">apply</span>(data, <span class="sc">&lt;</span>axis<span class="sc">&gt;</span>, <span class="cf">function</span>(x) (x <span class="sc">-</span> <span class="fu">mean</span>(x)) <span class="sc">/</span> <span class="fu">sd</span>(x))</span></code><button title="Kopiuj do schowka" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Poprzednie przykłady w tej książce normalizowały dane przed wprowadzeniem ich do modeli. Ale normalizacja danych może być interesująca po każdym przekształceniu dokonanym przez sieć: nawet jeśli dane wchodzące do sieci Dense lub Conv2D mają średnią 0 i jednostkową wariancję, nie ma powodu, by a priori oczekiwać, że tak będzie w przypadku danych wychodzących. Czy normalizacja aktywacji pośrednich mogłaby pomóc?</p>

<div class="no-row-height column-margin column-container"><div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/Bayu Angora.gif" class="img-fluid figure-img" width="400"></p>
</figure>
</div></div><p>Normalizacja partii danych jest to rodzaj warstwy (<code>layer_batch_normalization()</code> w <code>keras</code>) wprowadzonej w 2015 roku przez <span class="citation" data-cites="ioffeBatchNormalizationAccelerating2015">Ioffe i Szegedy (<a href="references.html#ref-ioffeBatchNormalizationAccelerating2015" role="doc-biblioref">2015</a>)</span>; może ona adaptacyjnie normalizować dane, nawet gdy średnia i wariancja zmieniają się w czasie treningu. Podczas szkolenia używa średniej i wariancji bieżącej partii danych do normalizacji próbek, a podczas wnioskowania (gdy wystarczająco duża partia reprezentatywnych danych może nie być dostępna), używa wykładniczej średniej ruchomej i wariancji danych widzianych podczas szkolenia.</p>
<p>Chociaż w oryginalnym artykule stwierdzono, że normalizacja partii działa poprzez “redukcję wewnętrznego przesunięcia kowariancji”, nikt tak naprawdę nie wie na pewno, dlaczego normalizacja partii pomaga. Różne hipotezy istnieją, ale nie ma pewności.</p>
<p>W praktyce, głównym efektem normalizacji partii wydaje się być to, że pomaga ona w propagacji gradientu - podobnie jak połączenia resztkowe - i tym samym pozwala na tworzenie głębszych sieci. Niektóre bardzo głębokie sieci mogą być trenowane tylko wtedy, gdy zawierają wiele warstw <em>BatchNormalization</em>. Na przykład, normalizacja partii jest szeroko stosowana w wielu zaawansowanych architekturach sieci konwolucyjnych, które są dostarczane z <code>keras</code>, takich jak ResNet50, EfficientNet i Xception.</p>
<p>Zarówno <code>layer_dense()</code> jak i <code>layer_conv_2d()</code> wykorzystują wektor obciążeń (ang. <em>bias</em>), wyuczoną zmienną, której celem jest uczynienie warstwy afiniczną, a nie czysto liniową. Na przykład, funkcja <code>layer_ conv_2d()</code> zwraca, <code>y = conv(x, kernel) + bias</code>, a <code>layer_dense()</code> zwraca <code>y = dot(x, kernel) + bias</code>. Ponieważ krok normalizacji zajmie się wyśrodkowaniem wyjścia warstwy na zero, wektor obciążenia nie jest już potrzebny w użyciu funkcji <code>layer_batch_normalization()</code>, a warstwę można utworzyć bez niego za pomocą opcji <code>use_bias = FALSE</code>.</p>
<p>Co ważne, generalnie zalecałbym umieszczanie aktywacji poprzedniej warstwy po warstwie normalizacji wsadowej (choć to wciąż temat do dyskusji).</p>
<div class="cell">
<details open="">
<summary>Kod</summary>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>x <span class="sc">|&gt;</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a> <span class="fu">layer_conv_2d</span>(<span class="dv">32</span>, <span class="dv">3</span>, <span class="at">activation =</span> <span class="st">"relu"</span>) <span class="sc">|&gt;</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a> <span class="fu">layer_batch_normalization</span>()</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a><span class="co"># lub</span></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>x <span class="sc">|&gt;</span></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">layer_conv_2d</span>(<span class="dv">32</span>, <span class="dv">3</span>, <span class="at">use_bias =</span> <span class="cn">FALSE</span>) <span class="sc">|&gt;</span></span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">layer_batch_normalization</span>() <span class="sc">|&gt;</span></span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">layer_activation</span>(<span class="st">"relu"</span>)</span></code><button title="Kopiuj do schowka" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Intuicyjnym powodem tego podejścia jest to, że normalizacja partii skupi naszes wejścia na zerze, podczas gdy nasza aktywacja <code>relu</code> używa zera jako punktu zwrotnego dla utrzymania lub porzucenia aktywowanych kanałów: robienie normalizacji przed aktywacją maksymalizuje wykorzystanie <code>relu</code>.</p>
<p>Normalizacja partii wiążę się też z szeregiem pułapek. Jedna z głównych dotyczy dostrajania: podczas dostrajania modelu, który zawiera warstwy BatchNormalization, zaleca się pozostawienie tych warstw zamrożonymi (wywołaj <code>freeze_weights()</code>, aby ustawić ich atrybut <code>trainable</code> na <code>FALSE</code>). W przeciwnym razie, będą one aktualizować swoją wewnętrzną średnią i wariancję, co może kolidować z bardzo małymi aktualizacjami zastosowanymi w otaczających warstwach Conv2D:</p>
<div class="cell">
<details open="">
<summary>Kod</summary>
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>batch_norm_layer_s3_classname <span class="ot">&lt;-</span> <span class="fu">class</span>(<span class="fu">layer_batch_normalization</span>())[<span class="dv">1</span>]</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>batch_norm_layer_s3_classname</span></code><button title="Kopiuj do schowka" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "keras.layers.normalization.batch_normalization.BatchNormalization"</code></pre>
</div>
<details open="">
<summary>Kod</summary>
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>is_batch_norm_layer <span class="ot">&lt;-</span> <span class="cf">function</span>(x) <span class="fu">inherits</span>(x, batch_norm_layer_s3_classname)</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>model <span class="ot">&lt;-</span> <span class="fu">application_efficientnet_b0</span>()</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (layer <span class="cf">in</span> model<span class="sc">$</span>layers) {</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is_batch_norm_layer</span>(layer)) {</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>    layer<span class="sc">$</span>trainable <span class="ot">&lt;-</span> <span class="cn">FALSE</span></span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a>model</span></code><button title="Kopiuj do schowka" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Model: "efficientnetb0"
________________________________________________________________________________
 Layer (type)         Output Shape   Param #  Connected to           Trainable  
================================================================================
 input_5 (InputLayer)  [(None, 224,   0       []                     Y          
                      224, 3)]                                                  
 rescaling_2 (Rescali  (None, 224, 2  0       ['input_5[0][0]']      Y          
 ng)                  24, 3)                                                    
 normalization (Norma  (None, 224, 2  7       ['rescaling_2[0][0]']  Y          
 lization)            24, 3)                                                    
 rescaling_3 (Rescali  (None, 224, 2  0       ['normalization[0][0]  Y          
 ng)                  24, 3)                  ']                                
 stem_conv_pad (ZeroP  (None, 225, 2  0       ['rescaling_3[0][0]']  Y          
 adding2D)            25, 3)                                                    
 stem_conv (Conv2D)   (None, 112, 1  864      ['stem_conv_pad[0][0]  Y          
                      12, 32)                 ']                                
 stem_bn (BatchNormal  (None, 112, 1  128     ['stem_conv[0][0]']    N          
 ization)             12, 32)                                                   
 stem_activation (Act  (None, 112, 1  0       ['stem_bn[0][0]']      Y          
 ivation)             12, 32)                                                   
 block1a_dwconv (Dept  (None, 112, 1  288     ['stem_activation[0][  Y          
 hwiseConv2D)         12, 32)                 0]']                              
 block1a_bn (BatchNor  (None, 112, 1  128     ['block1a_dwconv[0][0  N          
 malization)          12, 32)                 ]']                               
 block1a_activation (  (None, 112, 1  0       ['block1a_bn[0][0]']   Y          
 Activation)          12, 32)                                                   
 block1a_se_squeeze (  (None, 32)    0        ['block1a_activation[  Y          
 GlobalAveragePooling                         0][0]']                           
 2D)                                                                            
 block1a_se_reshape (  (None, 1, 1,   0       ['block1a_se_squeeze[  Y          
 Reshape)             32)                     0][0]']                           
 block1a_se_reduce (C  (None, 1, 1,   264     ['block1a_se_reshape[  Y          
 onv2D)               8)                      0][0]']                           
 block1a_se_expand (C  (None, 1, 1,   288     ['block1a_se_reduce[0  Y          
 onv2D)               32)                     ][0]']                            
 block1a_se_excite (M  (None, 112, 1  0       ['block1a_activation[  Y          
 ultiply)             12, 32)                 0][0]',                           
                                               'block1a_se_expand[0             
                                              ][0]']                            
 block1a_project_conv  (None, 112, 1  512     ['block1a_se_excite[0  Y          
  (Conv2D)            12, 16)                 ][0]']                            
 block1a_project_bn (  (None, 112, 1  64      ['block1a_project_con  N          
 BatchNormalization)  12, 16)                 v[0][0]']                         
 block2a_expand_conv   (None, 112, 1  1536    ['block1a_project_bn[  Y          
 (Conv2D)             12, 96)                 0][0]']                           
 block2a_expand_bn (B  (None, 112, 1  384     ['block2a_expand_conv  N          
 atchNormalization)   12, 96)                 [0][0]']                          
 block2a_expand_activ  (None, 112, 1  0       ['block2a_expand_bn[0  Y          
 ation (Activation)   12, 96)                 ][0]']                            
 block2a_dwconv_pad (  (None, 113, 1  0       ['block2a_expand_acti  Y          
 ZeroPadding2D)       13, 96)                 vation[0][0]']                    
 block2a_dwconv (Dept  (None, 56, 56  864     ['block2a_dwconv_pad[  Y          
 hwiseConv2D)         , 96)                   0][0]']                           
 block2a_bn (BatchNor  (None, 56, 56  384     ['block2a_dwconv[0][0  N          
 malization)          , 96)                   ]']                               
 block2a_activation (  (None, 56, 56  0       ['block2a_bn[0][0]']   Y          
 Activation)          , 96)                                                     
 block2a_se_squeeze (  (None, 96)    0        ['block2a_activation[  Y          
 GlobalAveragePooling                         0][0]']                           
 2D)                                                                            
 block2a_se_reshape (  (None, 1, 1,   0       ['block2a_se_squeeze[  Y          
 Reshape)             96)                     0][0]']                           
 block2a_se_reduce (C  (None, 1, 1,   388     ['block2a_se_reshape[  Y          
 onv2D)               4)                      0][0]']                           
 block2a_se_expand (C  (None, 1, 1,   480     ['block2a_se_reduce[0  Y          
 onv2D)               96)                     ][0]']                            
 block2a_se_excite (M  (None, 56, 56  0       ['block2a_activation[  Y          
 ultiply)             , 96)                   0][0]',                           
                                               'block2a_se_expand[0             
                                              ][0]']                            
 block2a_project_conv  (None, 56, 56  2304    ['block2a_se_excite[0  Y          
  (Conv2D)            , 24)                   ][0]']                            
 block2a_project_bn (  (None, 56, 56  96      ['block2a_project_con  N          
 BatchNormalization)  , 24)                   v[0][0]']                         
 block2b_expand_conv   (None, 56, 56  3456    ['block2a_project_bn[  Y          
 (Conv2D)             , 144)                  0][0]']                           
 block2b_expand_bn (B  (None, 56, 56  576     ['block2b_expand_conv  N          
 atchNormalization)   , 144)                  [0][0]']                          
 block2b_expand_activ  (None, 56, 56  0       ['block2b_expand_bn[0  Y          
 ation (Activation)   , 144)                  ][0]']                            
 block2b_dwconv (Dept  (None, 56, 56  1296    ['block2b_expand_acti  Y          
 hwiseConv2D)         , 144)                  vation[0][0]']                    
 block2b_bn (BatchNor  (None, 56, 56  576     ['block2b_dwconv[0][0  N          
 malization)          , 144)                  ]']                               
 block2b_activation (  (None, 56, 56  0       ['block2b_bn[0][0]']   Y          
 Activation)          , 144)                                                    
 block2b_se_squeeze (  (None, 144)   0        ['block2b_activation[  Y          
 GlobalAveragePooling                         0][0]']                           
 2D)                                                                            
 block2b_se_reshape (  (None, 1, 1,   0       ['block2b_se_squeeze[  Y          
 Reshape)             144)                    0][0]']                           
 block2b_se_reduce (C  (None, 1, 1,   870     ['block2b_se_reshape[  Y          
 onv2D)               6)                      0][0]']                           
 block2b_se_expand (C  (None, 1, 1,   1008    ['block2b_se_reduce[0  Y          
 onv2D)               144)                    ][0]']                            
 block2b_se_excite (M  (None, 56, 56  0       ['block2b_activation[  Y          
 ultiply)             , 144)                  0][0]',                           
                                               'block2b_se_expand[0             
                                              ][0]']                            
 block2b_project_conv  (None, 56, 56  3456    ['block2b_se_excite[0  Y          
  (Conv2D)            , 24)                   ][0]']                            
 block2b_project_bn (  (None, 56, 56  96      ['block2b_project_con  N          
 BatchNormalization)  , 24)                   v[0][0]']                         
 block2b_drop (Dropou  (None, 56, 56  0       ['block2b_project_bn[  Y          
 t)                   , 24)                   0][0]']                           
 block2b_add (Add)    (None, 56, 56  0        ['block2b_drop[0][0]'  Y          
                      , 24)                   , 'block2a_project_bn             
                                              [0][0]']                          
 block3a_expand_conv   (None, 56, 56  3456    ['block2b_add[0][0]']  Y          
 (Conv2D)             , 144)                                                    
 block3a_expand_bn (B  (None, 56, 56  576     ['block3a_expand_conv  N          
 atchNormalization)   , 144)                  [0][0]']                          
 block3a_expand_activ  (None, 56, 56  0       ['block3a_expand_bn[0  Y          
 ation (Activation)   , 144)                  ][0]']                            
 block3a_dwconv_pad (  (None, 59, 59  0       ['block3a_expand_acti  Y          
 ZeroPadding2D)       , 144)                  vation[0][0]']                    
 block3a_dwconv (Dept  (None, 28, 28  3600    ['block3a_dwconv_pad[  Y          
 hwiseConv2D)         , 144)                  0][0]']                           
 block3a_bn (BatchNor  (None, 28, 28  576     ['block3a_dwconv[0][0  N          
 malization)          , 144)                  ]']                               
 block3a_activation (  (None, 28, 28  0       ['block3a_bn[0][0]']   Y          
 Activation)          , 144)                                                    
 block3a_se_squeeze (  (None, 144)   0        ['block3a_activation[  Y          
 GlobalAveragePooling                         0][0]']                           
 2D)                                                                            
 block3a_se_reshape (  (None, 1, 1,   0       ['block3a_se_squeeze[  Y          
 Reshape)             144)                    0][0]']                           
 block3a_se_reduce (C  (None, 1, 1,   870     ['block3a_se_reshape[  Y          
 onv2D)               6)                      0][0]']                           
 block3a_se_expand (C  (None, 1, 1,   1008    ['block3a_se_reduce[0  Y          
 onv2D)               144)                    ][0]']                            
 block3a_se_excite (M  (None, 28, 28  0       ['block3a_activation[  Y          
 ultiply)             , 144)                  0][0]',                           
                                               'block3a_se_expand[0             
                                              ][0]']                            
 block3a_project_conv  (None, 28, 28  5760    ['block3a_se_excite[0  Y          
  (Conv2D)            , 40)                   ][0]']                            
 block3a_project_bn (  (None, 28, 28  160     ['block3a_project_con  N          
 BatchNormalization)  , 40)                   v[0][0]']                         
 block3b_expand_conv   (None, 28, 28  9600    ['block3a_project_bn[  Y          
 (Conv2D)             , 240)                  0][0]']                           
 block3b_expand_bn (B  (None, 28, 28  960     ['block3b_expand_conv  N          
 atchNormalization)   , 240)                  [0][0]']                          
 block3b_expand_activ  (None, 28, 28  0       ['block3b_expand_bn[0  Y          
 ation (Activation)   , 240)                  ][0]']                            
 block3b_dwconv (Dept  (None, 28, 28  6000    ['block3b_expand_acti  Y          
 hwiseConv2D)         , 240)                  vation[0][0]']                    
 block3b_bn (BatchNor  (None, 28, 28  960     ['block3b_dwconv[0][0  N          
 malization)          , 240)                  ]']                               
 block3b_activation (  (None, 28, 28  0       ['block3b_bn[0][0]']   Y          
 Activation)          , 240)                                                    
 block3b_se_squeeze (  (None, 240)   0        ['block3b_activation[  Y          
 GlobalAveragePooling                         0][0]']                           
 2D)                                                                            
 block3b_se_reshape (  (None, 1, 1,   0       ['block3b_se_squeeze[  Y          
 Reshape)             240)                    0][0]']                           
 block3b_se_reduce (C  (None, 1, 1,   2410    ['block3b_se_reshape[  Y          
 onv2D)               10)                     0][0]']                           
 block3b_se_expand (C  (None, 1, 1,   2640    ['block3b_se_reduce[0  Y          
 onv2D)               240)                    ][0]']                            
 block3b_se_excite (M  (None, 28, 28  0       ['block3b_activation[  Y          
 ultiply)             , 240)                  0][0]',                           
                                               'block3b_se_expand[0             
                                              ][0]']                            
 block3b_project_conv  (None, 28, 28  9600    ['block3b_se_excite[0  Y          
  (Conv2D)            , 40)                   ][0]']                            
 block3b_project_bn (  (None, 28, 28  160     ['block3b_project_con  N          
 BatchNormalization)  , 40)                   v[0][0]']                         
 block3b_drop (Dropou  (None, 28, 28  0       ['block3b_project_bn[  Y          
 t)                   , 40)                   0][0]']                           
 block3b_add (Add)    (None, 28, 28  0        ['block3b_drop[0][0]'  Y          
                      , 40)                   , 'block3a_project_bn             
                                              [0][0]']                          
 block4a_expand_conv   (None, 28, 28  9600    ['block3b_add[0][0]']  Y          
 (Conv2D)             , 240)                                                    
 block4a_expand_bn (B  (None, 28, 28  960     ['block4a_expand_conv  N          
 atchNormalization)   , 240)                  [0][0]']                          
 block4a_expand_activ  (None, 28, 28  0       ['block4a_expand_bn[0  Y          
 ation (Activation)   , 240)                  ][0]']                            
 block4a_dwconv_pad (  (None, 29, 29  0       ['block4a_expand_acti  Y          
 ZeroPadding2D)       , 240)                  vation[0][0]']                    
 block4a_dwconv (Dept  (None, 14, 14  2160    ['block4a_dwconv_pad[  Y          
 hwiseConv2D)         , 240)                  0][0]']                           
 block4a_bn (BatchNor  (None, 14, 14  960     ['block4a_dwconv[0][0  N          
 malization)          , 240)                  ]']                               
 block4a_activation (  (None, 14, 14  0       ['block4a_bn[0][0]']   Y          
 Activation)          , 240)                                                    
 block4a_se_squeeze (  (None, 240)   0        ['block4a_activation[  Y          
 GlobalAveragePooling                         0][0]']                           
 2D)                                                                            
 block4a_se_reshape (  (None, 1, 1,   0       ['block4a_se_squeeze[  Y          
 Reshape)             240)                    0][0]']                           
 block4a_se_reduce (C  (None, 1, 1,   2410    ['block4a_se_reshape[  Y          
 onv2D)               10)                     0][0]']                           
 block4a_se_expand (C  (None, 1, 1,   2640    ['block4a_se_reduce[0  Y          
 onv2D)               240)                    ][0]']                            
 block4a_se_excite (M  (None, 14, 14  0       ['block4a_activation[  Y          
 ultiply)             , 240)                  0][0]',                           
                                               'block4a_se_expand[0             
                                              ][0]']                            
 block4a_project_conv  (None, 14, 14  19200   ['block4a_se_excite[0  Y          
  (Conv2D)            , 80)                   ][0]']                            
 block4a_project_bn (  (None, 14, 14  320     ['block4a_project_con  N          
 BatchNormalization)  , 80)                   v[0][0]']                         
 block4b_expand_conv   (None, 14, 14  38400   ['block4a_project_bn[  Y          
 (Conv2D)             , 480)                  0][0]']                           
 block4b_expand_bn (B  (None, 14, 14  1920    ['block4b_expand_conv  N          
 atchNormalization)   , 480)                  [0][0]']                          
 block4b_expand_activ  (None, 14, 14  0       ['block4b_expand_bn[0  Y          
 ation (Activation)   , 480)                  ][0]']                            
 block4b_dwconv (Dept  (None, 14, 14  4320    ['block4b_expand_acti  Y          
 hwiseConv2D)         , 480)                  vation[0][0]']                    
 block4b_bn (BatchNor  (None, 14, 14  1920    ['block4b_dwconv[0][0  N          
 malization)          , 480)                  ]']                               
 block4b_activation (  (None, 14, 14  0       ['block4b_bn[0][0]']   Y          
 Activation)          , 480)                                                    
 block4b_se_squeeze (  (None, 480)   0        ['block4b_activation[  Y          
 GlobalAveragePooling                         0][0]']                           
 2D)                                                                            
 block4b_se_reshape (  (None, 1, 1,   0       ['block4b_se_squeeze[  Y          
 Reshape)             480)                    0][0]']                           
 block4b_se_reduce (C  (None, 1, 1,   9620    ['block4b_se_reshape[  Y          
 onv2D)               20)                     0][0]']                           
 block4b_se_expand (C  (None, 1, 1,   10080   ['block4b_se_reduce[0  Y          
 onv2D)               480)                    ][0]']                            
 block4b_se_excite (M  (None, 14, 14  0       ['block4b_activation[  Y          
 ultiply)             , 480)                  0][0]',                           
                                               'block4b_se_expand[0             
                                              ][0]']                            
 block4b_project_conv  (None, 14, 14  38400   ['block4b_se_excite[0  Y          
  (Conv2D)            , 80)                   ][0]']                            
 block4b_project_bn (  (None, 14, 14  320     ['block4b_project_con  N          
 BatchNormalization)  , 80)                   v[0][0]']                         
 block4b_drop (Dropou  (None, 14, 14  0       ['block4b_project_bn[  Y          
 t)                   , 80)                   0][0]']                           
 block4b_add (Add)    (None, 14, 14  0        ['block4b_drop[0][0]'  Y          
                      , 80)                   , 'block4a_project_bn             
                                              [0][0]']                          
 block4c_expand_conv   (None, 14, 14  38400   ['block4b_add[0][0]']  Y          
 (Conv2D)             , 480)                                                    
 block4c_expand_bn (B  (None, 14, 14  1920    ['block4c_expand_conv  N          
 atchNormalization)   , 480)                  [0][0]']                          
 block4c_expand_activ  (None, 14, 14  0       ['block4c_expand_bn[0  Y          
 ation (Activation)   , 480)                  ][0]']                            
 block4c_dwconv (Dept  (None, 14, 14  4320    ['block4c_expand_acti  Y          
 hwiseConv2D)         , 480)                  vation[0][0]']                    
 block4c_bn (BatchNor  (None, 14, 14  1920    ['block4c_dwconv[0][0  N          
 malization)          , 480)                  ]']                               
 block4c_activation (  (None, 14, 14  0       ['block4c_bn[0][0]']   Y          
 Activation)          , 480)                                                    
 block4c_se_squeeze (  (None, 480)   0        ['block4c_activation[  Y          
 GlobalAveragePooling                         0][0]']                           
 2D)                                                                            
 block4c_se_reshape (  (None, 1, 1,   0       ['block4c_se_squeeze[  Y          
 Reshape)             480)                    0][0]']                           
 block4c_se_reduce (C  (None, 1, 1,   9620    ['block4c_se_reshape[  Y          
 onv2D)               20)                     0][0]']                           
 block4c_se_expand (C  (None, 1, 1,   10080   ['block4c_se_reduce[0  Y          
 onv2D)               480)                    ][0]']                            
 block4c_se_excite (M  (None, 14, 14  0       ['block4c_activation[  Y          
 ultiply)             , 480)                  0][0]',                           
                                               'block4c_se_expand[0             
                                              ][0]']                            
 block4c_project_conv  (None, 14, 14  38400   ['block4c_se_excite[0  Y          
  (Conv2D)            , 80)                   ][0]']                            
 block4c_project_bn (  (None, 14, 14  320     ['block4c_project_con  N          
 BatchNormalization)  , 80)                   v[0][0]']                         
 block4c_drop (Dropou  (None, 14, 14  0       ['block4c_project_bn[  Y          
 t)                   , 80)                   0][0]']                           
 block4c_add (Add)    (None, 14, 14  0        ['block4c_drop[0][0]'  Y          
                      , 80)                   , 'block4b_add[0][0]'             
                                              ]                                 
 block5a_expand_conv   (None, 14, 14  38400   ['block4c_add[0][0]']  Y          
 (Conv2D)             , 480)                                                    
 block5a_expand_bn (B  (None, 14, 14  1920    ['block5a_expand_conv  N          
 atchNormalization)   , 480)                  [0][0]']                          
 block5a_expand_activ  (None, 14, 14  0       ['block5a_expand_bn[0  Y          
 ation (Activation)   , 480)                  ][0]']                            
 block5a_dwconv (Dept  (None, 14, 14  12000   ['block5a_expand_acti  Y          
 hwiseConv2D)         , 480)                  vation[0][0]']                    
 block5a_bn (BatchNor  (None, 14, 14  1920    ['block5a_dwconv[0][0  N          
 malization)          , 480)                  ]']                               
 block5a_activation (  (None, 14, 14  0       ['block5a_bn[0][0]']   Y          
 Activation)          , 480)                                                    
 block5a_se_squeeze (  (None, 480)   0        ['block5a_activation[  Y          
 GlobalAveragePooling                         0][0]']                           
 2D)                                                                            
 block5a_se_reshape (  (None, 1, 1,   0       ['block5a_se_squeeze[  Y          
 Reshape)             480)                    0][0]']                           
 block5a_se_reduce (C  (None, 1, 1,   9620    ['block5a_se_reshape[  Y          
 onv2D)               20)                     0][0]']                           
 block5a_se_expand (C  (None, 1, 1,   10080   ['block5a_se_reduce[0  Y          
 onv2D)               480)                    ][0]']                            
 block5a_se_excite (M  (None, 14, 14  0       ['block5a_activation[  Y          
 ultiply)             , 480)                  0][0]',                           
                                               'block5a_se_expand[0             
                                              ][0]']                            
 block5a_project_conv  (None, 14, 14  53760   ['block5a_se_excite[0  Y          
  (Conv2D)            , 112)                  ][0]']                            
 block5a_project_bn (  (None, 14, 14  448     ['block5a_project_con  N          
 BatchNormalization)  , 112)                  v[0][0]']                         
 block5b_expand_conv   (None, 14, 14  75264   ['block5a_project_bn[  Y          
 (Conv2D)             , 672)                  0][0]']                           
 block5b_expand_bn (B  (None, 14, 14  2688    ['block5b_expand_conv  N          
 atchNormalization)   , 672)                  [0][0]']                          
 block5b_expand_activ  (None, 14, 14  0       ['block5b_expand_bn[0  Y          
 ation (Activation)   , 672)                  ][0]']                            
 block5b_dwconv (Dept  (None, 14, 14  16800   ['block5b_expand_acti  Y          
 hwiseConv2D)         , 672)                  vation[0][0]']                    
 block5b_bn (BatchNor  (None, 14, 14  2688    ['block5b_dwconv[0][0  N          
 malization)          , 672)                  ]']                               
 block5b_activation (  (None, 14, 14  0       ['block5b_bn[0][0]']   Y          
 Activation)          , 672)                                                    
 block5b_se_squeeze (  (None, 672)   0        ['block5b_activation[  Y          
 GlobalAveragePooling                         0][0]']                           
 2D)                                                                            
 block5b_se_reshape (  (None, 1, 1,   0       ['block5b_se_squeeze[  Y          
 Reshape)             672)                    0][0]']                           
 block5b_se_reduce (C  (None, 1, 1,   18844   ['block5b_se_reshape[  Y          
 onv2D)               28)                     0][0]']                           
 block5b_se_expand (C  (None, 1, 1,   19488   ['block5b_se_reduce[0  Y          
 onv2D)               672)                    ][0]']                            
 block5b_se_excite (M  (None, 14, 14  0       ['block5b_activation[  Y          
 ultiply)             , 672)                  0][0]',                           
                                               'block5b_se_expand[0             
                                              ][0]']                            
 block5b_project_conv  (None, 14, 14  75264   ['block5b_se_excite[0  Y          
  (Conv2D)            , 112)                  ][0]']                            
 block5b_project_bn (  (None, 14, 14  448     ['block5b_project_con  N          
 BatchNormalization)  , 112)                  v[0][0]']                         
 block5b_drop (Dropou  (None, 14, 14  0       ['block5b_project_bn[  Y          
 t)                   , 112)                  0][0]']                           
 block5b_add (Add)    (None, 14, 14  0        ['block5b_drop[0][0]'  Y          
                      , 112)                  , 'block5a_project_bn             
                                              [0][0]']                          
 block5c_expand_conv   (None, 14, 14  75264   ['block5b_add[0][0]']  Y          
 (Conv2D)             , 672)                                                    
 block5c_expand_bn (B  (None, 14, 14  2688    ['block5c_expand_conv  N          
 atchNormalization)   , 672)                  [0][0]']                          
 block5c_expand_activ  (None, 14, 14  0       ['block5c_expand_bn[0  Y          
 ation (Activation)   , 672)                  ][0]']                            
 block5c_dwconv (Dept  (None, 14, 14  16800   ['block5c_expand_acti  Y          
 hwiseConv2D)         , 672)                  vation[0][0]']                    
 block5c_bn (BatchNor  (None, 14, 14  2688    ['block5c_dwconv[0][0  N          
 malization)          , 672)                  ]']                               
 block5c_activation (  (None, 14, 14  0       ['block5c_bn[0][0]']   Y          
 Activation)          , 672)                                                    
 block5c_se_squeeze (  (None, 672)   0        ['block5c_activation[  Y          
 GlobalAveragePooling                         0][0]']                           
 2D)                                                                            
 block5c_se_reshape (  (None, 1, 1,   0       ['block5c_se_squeeze[  Y          
 Reshape)             672)                    0][0]']                           
 block5c_se_reduce (C  (None, 1, 1,   18844   ['block5c_se_reshape[  Y          
 onv2D)               28)                     0][0]']                           
 block5c_se_expand (C  (None, 1, 1,   19488   ['block5c_se_reduce[0  Y          
 onv2D)               672)                    ][0]']                            
 block5c_se_excite (M  (None, 14, 14  0       ['block5c_activation[  Y          
 ultiply)             , 672)                  0][0]',                           
                                               'block5c_se_expand[0             
                                              ][0]']                            
 block5c_project_conv  (None, 14, 14  75264   ['block5c_se_excite[0  Y          
  (Conv2D)            , 112)                  ][0]']                            
 block5c_project_bn (  (None, 14, 14  448     ['block5c_project_con  N          
 BatchNormalization)  , 112)                  v[0][0]']                         
 block5c_drop (Dropou  (None, 14, 14  0       ['block5c_project_bn[  Y          
 t)                   , 112)                  0][0]']                           
 block5c_add (Add)    (None, 14, 14  0        ['block5c_drop[0][0]'  Y          
                      , 112)                  , 'block5b_add[0][0]'             
                                              ]                                 
 block6a_expand_conv   (None, 14, 14  75264   ['block5c_add[0][0]']  Y          
 (Conv2D)             , 672)                                                    
 block6a_expand_bn (B  (None, 14, 14  2688    ['block6a_expand_conv  N          
 atchNormalization)   , 672)                  [0][0]']                          
 block6a_expand_activ  (None, 14, 14  0       ['block6a_expand_bn[0  Y          
 ation (Activation)   , 672)                  ][0]']                            
 block6a_dwconv_pad (  (None, 17, 17  0       ['block6a_expand_acti  Y          
 ZeroPadding2D)       , 672)                  vation[0][0]']                    
 block6a_dwconv (Dept  (None, 7, 7,   16800   ['block6a_dwconv_pad[  Y          
 hwiseConv2D)         672)                    0][0]']                           
 block6a_bn (BatchNor  (None, 7, 7,   2688    ['block6a_dwconv[0][0  N          
 malization)          672)                    ]']                               
 block6a_activation (  (None, 7, 7,   0       ['block6a_bn[0][0]']   Y          
 Activation)          672)                                                      
 block6a_se_squeeze (  (None, 672)   0        ['block6a_activation[  Y          
 GlobalAveragePooling                         0][0]']                           
 2D)                                                                            
 block6a_se_reshape (  (None, 1, 1,   0       ['block6a_se_squeeze[  Y          
 Reshape)             672)                    0][0]']                           
 block6a_se_reduce (C  (None, 1, 1,   18844   ['block6a_se_reshape[  Y          
 onv2D)               28)                     0][0]']                           
 block6a_se_expand (C  (None, 1, 1,   19488   ['block6a_se_reduce[0  Y          
 onv2D)               672)                    ][0]']                            
 block6a_se_excite (M  (None, 7, 7,   0       ['block6a_activation[  Y          
 ultiply)             672)                    0][0]',                           
                                               'block6a_se_expand[0             
                                              ][0]']                            
 block6a_project_conv  (None, 7, 7,   129024  ['block6a_se_excite[0  Y          
  (Conv2D)            192)                    ][0]']                            
 block6a_project_bn (  (None, 7, 7,   768     ['block6a_project_con  N          
 BatchNormalization)  192)                    v[0][0]']                         
 block6b_expand_conv   (None, 7, 7,   221184  ['block6a_project_bn[  Y          
 (Conv2D)             1152)                   0][0]']                           
 block6b_expand_bn (B  (None, 7, 7,   4608    ['block6b_expand_conv  N          
 atchNormalization)   1152)                   [0][0]']                          
 block6b_expand_activ  (None, 7, 7,   0       ['block6b_expand_bn[0  Y          
 ation (Activation)   1152)                   ][0]']                            
 block6b_dwconv (Dept  (None, 7, 7,   28800   ['block6b_expand_acti  Y          
 hwiseConv2D)         1152)                   vation[0][0]']                    
 block6b_bn (BatchNor  (None, 7, 7,   4608    ['block6b_dwconv[0][0  N          
 malization)          1152)                   ]']                               
 block6b_activation (  (None, 7, 7,   0       ['block6b_bn[0][0]']   Y          
 Activation)          1152)                                                     
 block6b_se_squeeze (  (None, 1152)  0        ['block6b_activation[  Y          
 GlobalAveragePooling                         0][0]']                           
 2D)                                                                            
 block6b_se_reshape (  (None, 1, 1,   0       ['block6b_se_squeeze[  Y          
 Reshape)             1152)                   0][0]']                           
 block6b_se_reduce (C  (None, 1, 1,   55344   ['block6b_se_reshape[  Y          
 onv2D)               48)                     0][0]']                           
 block6b_se_expand (C  (None, 1, 1,   56448   ['block6b_se_reduce[0  Y          
 onv2D)               1152)                   ][0]']                            
 block6b_se_excite (M  (None, 7, 7,   0       ['block6b_activation[  Y          
 ultiply)             1152)                   0][0]',                           
                                               'block6b_se_expand[0             
                                              ][0]']                            
 block6b_project_conv  (None, 7, 7,   221184  ['block6b_se_excite[0  Y          
  (Conv2D)            192)                    ][0]']                            
 block6b_project_bn (  (None, 7, 7,   768     ['block6b_project_con  N          
 BatchNormalization)  192)                    v[0][0]']                         
 block6b_drop (Dropou  (None, 7, 7,   0       ['block6b_project_bn[  Y          
 t)                   192)                    0][0]']                           
 block6b_add (Add)    (None, 7, 7,   0        ['block6b_drop[0][0]'  Y          
                      192)                    , 'block6a_project_bn             
                                              [0][0]']                          
 block6c_expand_conv   (None, 7, 7,   221184  ['block6b_add[0][0]']  Y          
 (Conv2D)             1152)                                                     
 block6c_expand_bn (B  (None, 7, 7,   4608    ['block6c_expand_conv  N          
 atchNormalization)   1152)                   [0][0]']                          
 block6c_expand_activ  (None, 7, 7,   0       ['block6c_expand_bn[0  Y          
 ation (Activation)   1152)                   ][0]']                            
 block6c_dwconv (Dept  (None, 7, 7,   28800   ['block6c_expand_acti  Y          
 hwiseConv2D)         1152)                   vation[0][0]']                    
 block6c_bn (BatchNor  (None, 7, 7,   4608    ['block6c_dwconv[0][0  N          
 malization)          1152)                   ]']                               
 block6c_activation (  (None, 7, 7,   0       ['block6c_bn[0][0]']   Y          
 Activation)          1152)                                                     
 block6c_se_squeeze (  (None, 1152)  0        ['block6c_activation[  Y          
 GlobalAveragePooling                         0][0]']                           
 2D)                                                                            
 block6c_se_reshape (  (None, 1, 1,   0       ['block6c_se_squeeze[  Y          
 Reshape)             1152)                   0][0]']                           
 block6c_se_reduce (C  (None, 1, 1,   55344   ['block6c_se_reshape[  Y          
 onv2D)               48)                     0][0]']                           
 block6c_se_expand (C  (None, 1, 1,   56448   ['block6c_se_reduce[0  Y          
 onv2D)               1152)                   ][0]']                            
 block6c_se_excite (M  (None, 7, 7,   0       ['block6c_activation[  Y          
 ultiply)             1152)                   0][0]',                           
                                               'block6c_se_expand[0             
                                              ][0]']                            
 block6c_project_conv  (None, 7, 7,   221184  ['block6c_se_excite[0  Y          
  (Conv2D)            192)                    ][0]']                            
 block6c_project_bn (  (None, 7, 7,   768     ['block6c_project_con  N          
 BatchNormalization)  192)                    v[0][0]']                         
 block6c_drop (Dropou  (None, 7, 7,   0       ['block6c_project_bn[  Y          
 t)                   192)                    0][0]']                           
 block6c_add (Add)    (None, 7, 7,   0        ['block6c_drop[0][0]'  Y          
                      192)                    , 'block6b_add[0][0]'             
                                              ]                                 
 block6d_expand_conv   (None, 7, 7,   221184  ['block6c_add[0][0]']  Y          
 (Conv2D)             1152)                                                     
 block6d_expand_bn (B  (None, 7, 7,   4608    ['block6d_expand_conv  N          
 atchNormalization)   1152)                   [0][0]']                          
 block6d_expand_activ  (None, 7, 7,   0       ['block6d_expand_bn[0  Y          
 ation (Activation)   1152)                   ][0]']                            
 block6d_dwconv (Dept  (None, 7, 7,   28800   ['block6d_expand_acti  Y          
 hwiseConv2D)         1152)                   vation[0][0]']                    
 block6d_bn (BatchNor  (None, 7, 7,   4608    ['block6d_dwconv[0][0  N          
 malization)          1152)                   ]']                               
 block6d_activation (  (None, 7, 7,   0       ['block6d_bn[0][0]']   Y          
 Activation)          1152)                                                     
 block6d_se_squeeze (  (None, 1152)  0        ['block6d_activation[  Y          
 GlobalAveragePooling                         0][0]']                           
 2D)                                                                            
 block6d_se_reshape (  (None, 1, 1,   0       ['block6d_se_squeeze[  Y          
 Reshape)             1152)                   0][0]']                           
 block6d_se_reduce (C  (None, 1, 1,   55344   ['block6d_se_reshape[  Y          
 onv2D)               48)                     0][0]']                           
 block6d_se_expand (C  (None, 1, 1,   56448   ['block6d_se_reduce[0  Y          
 onv2D)               1152)                   ][0]']                            
 block6d_se_excite (M  (None, 7, 7,   0       ['block6d_activation[  Y          
 ultiply)             1152)                   0][0]',                           
                                               'block6d_se_expand[0             
                                              ][0]']                            
 block6d_project_conv  (None, 7, 7,   221184  ['block6d_se_excite[0  Y          
  (Conv2D)            192)                    ][0]']                            
 block6d_project_bn (  (None, 7, 7,   768     ['block6d_project_con  N          
 BatchNormalization)  192)                    v[0][0]']                         
 block6d_drop (Dropou  (None, 7, 7,   0       ['block6d_project_bn[  Y          
 t)                   192)                    0][0]']                           
 block6d_add (Add)    (None, 7, 7,   0        ['block6d_drop[0][0]'  Y          
                      192)                    , 'block6c_add[0][0]'             
                                              ]                                 
 block7a_expand_conv   (None, 7, 7,   221184  ['block6d_add[0][0]']  Y          
 (Conv2D)             1152)                                                     
 block7a_expand_bn (B  (None, 7, 7,   4608    ['block7a_expand_conv  N          
 atchNormalization)   1152)                   [0][0]']                          
 block7a_expand_activ  (None, 7, 7,   0       ['block7a_expand_bn[0  Y          
 ation (Activation)   1152)                   ][0]']                            
 block7a_dwconv (Dept  (None, 7, 7,   10368   ['block7a_expand_acti  Y          
 hwiseConv2D)         1152)                   vation[0][0]']                    
 block7a_bn (BatchNor  (None, 7, 7,   4608    ['block7a_dwconv[0][0  N          
 malization)          1152)                   ]']                               
 block7a_activation (  (None, 7, 7,   0       ['block7a_bn[0][0]']   Y          
 Activation)          1152)                                                     
 block7a_se_squeeze (  (None, 1152)  0        ['block7a_activation[  Y          
 GlobalAveragePooling                         0][0]']                           
 2D)                                                                            
 block7a_se_reshape (  (None, 1, 1,   0       ['block7a_se_squeeze[  Y          
 Reshape)             1152)                   0][0]']                           
 block7a_se_reduce (C  (None, 1, 1,   55344   ['block7a_se_reshape[  Y          
 onv2D)               48)                     0][0]']                           
 block7a_se_expand (C  (None, 1, 1,   56448   ['block7a_se_reduce[0  Y          
 onv2D)               1152)                   ][0]']                            
 block7a_se_excite (M  (None, 7, 7,   0       ['block7a_activation[  Y          
 ultiply)             1152)                   0][0]',                           
                                               'block7a_se_expand[0             
                                              ][0]']                            
 block7a_project_conv  (None, 7, 7,   368640  ['block7a_se_excite[0  Y          
  (Conv2D)            320)                    ][0]']                            
 block7a_project_bn (  (None, 7, 7,   1280    ['block7a_project_con  N          
 BatchNormalization)  320)                    v[0][0]']                         
 top_conv (Conv2D)    (None, 7, 7,   409600   ['block7a_project_bn[  Y          
                      1280)                   0][0]']                           
 top_bn (BatchNormali  (None, 7, 7,   5120    ['top_conv[0][0]']     N          
 zation)              1280)                                                     
 top_activation (Acti  (None, 7, 7,   0       ['top_bn[0][0]']       Y          
 vation)              1280)                                                     
 avg_pool (GlobalAver  (None, 1280)  0        ['top_activation[0][0  Y          
 agePooling2D)                                ]']                               
 top_dropout (Dropout  (None, 1280)  0        ['avg_pool[0][0]']     Y          
 )                                                                              
 predictions (Dense)  (None, 1000)   1281000  ['top_dropout[0][0]']  Y          
================================================================================
Total params: 5,330,571
Trainable params: 5,246,532
Non-trainable params: 84,039
________________________________________________________________________________</code></pre>
</div>
</div>
</section>
<section id="konwolucje-separowalne" class="level3 page-columns page-full" data-number="14.1.3">
<h3 data-number="14.1.3" class="anchored" data-anchor-id="konwolucje-separowalne"><span class="header-section-number">14.1.3</span> Konwolucje separowalne</h3>
<p>A gdybym powiedział, że istnieje warstwa, której możemy użyć jako zamiennika <code>layer_ conv_2d()</code>, która sprawi, że nasz model będzie mniejszy (mniej trenowanych parametrów) i szczuplejszy (mniej operacji zmiennoprzecinkowych) i spowoduje, że wykona kilka punktów procentowych lepiej swoje zadanie? To właśnie robi warstwa konwolucji separowalnej wgłębnie (<code>layer_separable_conv_2d()</code> w <code>keras</code>). Warstwa ta wykonuje konwolucję przestrzenną na każdym kanale swojego wejścia, niezależnie, przed zmieszaniem kanałów wyjściowych poprzez konwolucję punktową (konwolucja 1 × 1), jak pokazano na <a href="#fig-seg8">Rysunek&nbsp;<span>14.8</span></a></p>
<div id="fig-seg8" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="images/Zrzut ekranu 2023-03-18 o 16.05.49.png" class="img-fluid figure-img" width="600"></p>
<p></p><figcaption class="figure-caption">Rysunek&nbsp;14.8: Konwolucja separowalna</figcaption><p></p>
</figure>
</div>
<p>Jest to równoznaczne z rozdzieleniem uczenia się cech przestrzennych i uczenia się cech kanałowych. W podobny sposób, jak konwolucja opiera się na założeniu, że wzory w obrazach nie są związane z konkretnymi lokalizacjami, konwolucja separowalna wgłębnie opiera się na założeniu, że lokalizacje przestrzenne w aktywacjach pośrednich są wysoce skorelowane, ale różne kanały są wysoce niezależne . Ponieważ założenie to jest generalnie prawdziwe dla reprezentacji obrazów uczonych przez głębokie sieci neuronowe, służy jako użyteczne założenie, które pomaga modelowi bardziej efektywnie wykorzystać dane treningowe. Model z silniejszymi założeniami dotyczącymi struktury informacji, które będzie musiał przetworzyć, jest lepszym modelem - o ile założenia te są poprawne.</p>

<div class="no-row-height column-margin column-container"><div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://media.giphy.com/media/3ohfFoXZskaNkuCR32/giphy.gif" class="img-fluid figure-img" width="400"></p>
</figure>
</div></div><p>Konwolucja separowalna wymaga znacznie mniej parametrów i wymaga mniejszej ilości obliczeń niż zwykła konwolucja, a jednocześnie ma porównywalną moc reprezentacji. W rezultacie otrzymujemy mniejsze modele, które szybciej osiągają zbieżność i są mniej podatne na <em>overfitting</em>. Te zalety stają się szczególnie ważne, gdy trenujemy małe modele od podstaw na ograniczonych zbiorach danych.</p>
<p>Konwolucje separowalne wgłębnie są podstawą architektury Xception, wysokowydajnej sieci splotowej.</p>
</section>
<section id="przykład-wykorzystania-sieci-xception" class="level3" data-number="14.1.4">
<h3 data-number="14.1.4" class="anchored" data-anchor-id="przykład-wykorzystania-sieci-xception"><span class="header-section-number">14.1.4</span> Przykład wykorzystania sieci Xception</h3>
<p>Dla przypomnienia, oto zasady architektury sieci splotowej, które poznaliśmy do tej pory:</p>
<ul>
<li>Nasz model powinien być zorganizowany w powtarzające się bloki warstw, zwykle składających się z wielu warstw konwolucji i warstwy <em>max pooling</em>.</li>
<li>Liczba filtrów w naszych warstwach powinna rosnąć wraz ze zmniejszaniem się rozmiaru przestrzennych map cech.</li>
<li>Głębokie i wąskie sieci są lepsze niż szerokie i płytkie.</li>
<li>Wprowadzenie połączeń rezydualnych wokół bloków warstw pomaga trenować głębsze sieci.</li>
<li>Korzystne może być wprowadzenie warstw normalizacji partii po twoich warstwach konwolucji.</li>
<li>Korzystne może być zastąpienie <code>layer_conv_2d()</code> przez <code>layer_separable_conv_2d()</code>, które są bardziej wydajne pod względem parametrów.</li>
</ul>
<p>Zbierzmy te pomysły razem w jeden model. Jego architektura będzie przypominać sieć Xception. Zastosujemy ją do zadania psy vs.&nbsp;koty z poprzedniego rozdziału.</p>
<div class="cell">
<details open="">
<summary>Kod</summary>
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>data_augmentation <span class="ot">&lt;-</span> <span class="fu">keras_model_sequential</span>() <span class="sc">|&gt;</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">layer_random_flip</span>(<span class="st">"horizontal"</span>) <span class="sc">|&gt;</span></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">layer_random_rotation</span>(<span class="fl">0.1</span>) <span class="sc">|&gt;</span></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">layer_random_zoom</span>(<span class="fl">0.2</span>)</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>inputs <span class="ot">&lt;-</span> <span class="fu">layer_input</span>(<span class="at">shape =</span> <span class="fu">c</span>(<span class="dv">180</span>, <span class="dv">180</span>, <span class="dv">3</span>))</span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> inputs <span class="sc">|&gt;</span></span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data_augmentation</span>() <span class="sc">|&gt;</span></span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">layer_rescaling</span>(<span class="at">scale =</span> <span class="dv">1</span> <span class="sc">/</span> <span class="dv">255</span>)</span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> x <span class="sc">|&gt;</span></span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">layer_conv_2d</span>(<span class="dv">32</span>, <span class="dv">5</span>, <span class="at">use_bias =</span> <span class="cn">FALSE</span>)</span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (size <span class="cf">in</span> <span class="fu">c</span>(<span class="dv">32</span>, <span class="dv">64</span>, <span class="dv">128</span>, <span class="dv">256</span>, <span class="dv">512</span>)) {</span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true" tabindex="-1"></a>  residual <span class="ot">&lt;-</span> x</span>
<span id="cb28-17"><a href="#cb28-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-18"><a href="#cb28-18" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> x <span class="sc">|&gt;</span></span>
<span id="cb28-19"><a href="#cb28-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">layer_batch_normalization</span>() <span class="sc">|&gt;</span></span>
<span id="cb28-20"><a href="#cb28-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">layer_activation</span>(<span class="st">"relu"</span>) <span class="sc">|&gt;</span></span>
<span id="cb28-21"><a href="#cb28-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">layer_separable_conv_2d</span>(size, <span class="dv">3</span>, <span class="at">padding =</span> <span class="st">"same"</span>, <span class="at">use_bias =</span> <span class="cn">FALSE</span>) <span class="sc">|&gt;</span></span>
<span id="cb28-22"><a href="#cb28-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">layer_batch_normalization</span>() <span class="sc">|&gt;</span></span>
<span id="cb28-23"><a href="#cb28-23" aria-hidden="true" tabindex="-1"></a>    <span class="fu">layer_activation</span>(<span class="st">"relu"</span>) <span class="sc">|&gt;</span></span>
<span id="cb28-24"><a href="#cb28-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">layer_separable_conv_2d</span>(size, <span class="dv">3</span>, <span class="at">padding =</span> <span class="st">"same"</span>, <span class="at">use_bias =</span> <span class="cn">FALSE</span>) <span class="sc">|&gt;</span></span>
<span id="cb28-25"><a href="#cb28-25" aria-hidden="true" tabindex="-1"></a>    <span class="fu">layer_max_pooling_2d</span>(<span class="at">pool_size =</span> <span class="dv">3</span>, <span class="at">strides =</span> <span class="dv">2</span>, <span class="at">padding =</span> <span class="st">"same"</span>)</span>
<span id="cb28-26"><a href="#cb28-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-27"><a href="#cb28-27" aria-hidden="true" tabindex="-1"></a>  residual <span class="ot">&lt;-</span> residual <span class="sc">|&gt;</span></span>
<span id="cb28-28"><a href="#cb28-28" aria-hidden="true" tabindex="-1"></a>    <span class="fu">layer_conv_2d</span>(size, <span class="dv">1</span>, <span class="at">strides =</span> <span class="dv">2</span>, <span class="at">padding =</span> <span class="st">"same"</span>, <span class="at">use_bias =</span> <span class="cn">FALSE</span>)</span>
<span id="cb28-29"><a href="#cb28-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-30"><a href="#cb28-30" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">layer_add</span>(<span class="fu">list</span>(x, residual))</span>
<span id="cb28-31"><a href="#cb28-31" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb28-32"><a href="#cb28-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-33"><a href="#cb28-33" aria-hidden="true" tabindex="-1"></a>outputs <span class="ot">&lt;-</span> x <span class="sc">|&gt;</span></span>
<span id="cb28-34"><a href="#cb28-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">layer_global_average_pooling_2d</span>() <span class="sc">|&gt;</span></span>
<span id="cb28-35"><a href="#cb28-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">layer_dropout</span>(<span class="fl">0.5</span>) <span class="sc">|&gt;</span></span>
<span id="cb28-36"><a href="#cb28-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">layer_dense</span>(<span class="dv">1</span>, <span class="at">activation =</span> <span class="st">"sigmoid"</span>)</span>
<span id="cb28-37"><a href="#cb28-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-38"><a href="#cb28-38" aria-hidden="true" tabindex="-1"></a>model <span class="ot">&lt;-</span> <span class="fu">keras_model</span>(inputs, outputs)</span>
<span id="cb28-39"><a href="#cb28-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-40"><a href="#cb28-40" aria-hidden="true" tabindex="-1"></a>train_dataset <span class="ot">&lt;-</span> <span class="fu">image_dataset_from_directory</span>(</span>
<span id="cb28-41"><a href="#cb28-41" aria-hidden="true" tabindex="-1"></a>  <span class="st">"/Users/majerek/Downloads/cats_and_dogs_small/train/"</span>,</span>
<span id="cb28-42"><a href="#cb28-42" aria-hidden="true" tabindex="-1"></a>  <span class="at">image_size =</span> <span class="fu">c</span>(<span class="dv">180</span>, <span class="dv">180</span>),</span>
<span id="cb28-43"><a href="#cb28-43" aria-hidden="true" tabindex="-1"></a>  <span class="at">batch_size =</span> <span class="dv">32</span></span>
<span id="cb28-44"><a href="#cb28-44" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb28-45"><a href="#cb28-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-46"><a href="#cb28-46" aria-hidden="true" tabindex="-1"></a>validation_dataset <span class="ot">&lt;-</span> <span class="fu">image_dataset_from_directory</span>(</span>
<span id="cb28-47"><a href="#cb28-47" aria-hidden="true" tabindex="-1"></a>  <span class="st">"/Users/majerek/Downloads/cats_and_dogs_small/validation"</span>,</span>
<span id="cb28-48"><a href="#cb28-48" aria-hidden="true" tabindex="-1"></a>  <span class="at">image_size =</span> <span class="fu">c</span>(<span class="dv">180</span>, <span class="dv">180</span>),</span>
<span id="cb28-49"><a href="#cb28-49" aria-hidden="true" tabindex="-1"></a>  <span class="at">batch_size =</span> <span class="dv">32</span></span>
<span id="cb28-50"><a href="#cb28-50" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb28-51"><a href="#cb28-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-52"><a href="#cb28-52" aria-hidden="true" tabindex="-1"></a>callbacks <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="fu">callback_model_checkpoint</span>(<span class="at">filepath =</span> <span class="st">"models/vgg16_cat_dog.keras"</span>, <span class="at">save_best_only =</span> T))</span>
<span id="cb28-53"><a href="#cb28-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-54"><a href="#cb28-54" aria-hidden="true" tabindex="-1"></a>model <span class="sc">|&gt;</span></span>
<span id="cb28-55"><a href="#cb28-55" aria-hidden="true" tabindex="-1"></a>  keras<span class="sc">::</span><span class="fu">compile</span>(</span>
<span id="cb28-56"><a href="#cb28-56" aria-hidden="true" tabindex="-1"></a>    <span class="at">loss =</span> <span class="st">"binary_crossentropy"</span>,</span>
<span id="cb28-57"><a href="#cb28-57" aria-hidden="true" tabindex="-1"></a>    <span class="at">optimizer =</span> <span class="st">"rmsprop"</span>,</span>
<span id="cb28-58"><a href="#cb28-58" aria-hidden="true" tabindex="-1"></a>    <span class="at">metrics =</span> <span class="st">"accuracy"</span></span>
<span id="cb28-59"><a href="#cb28-59" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb28-60"><a href="#cb28-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-61"><a href="#cb28-61" aria-hidden="true" tabindex="-1"></a>history <span class="ot">&lt;-</span> model <span class="sc">|&gt;</span></span>
<span id="cb28-62"><a href="#cb28-62" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fit</span>(</span>
<span id="cb28-63"><a href="#cb28-63" aria-hidden="true" tabindex="-1"></a>    train_dataset,</span>
<span id="cb28-64"><a href="#cb28-64" aria-hidden="true" tabindex="-1"></a>    <span class="at">epochs =</span> <span class="dv">90</span>,</span>
<span id="cb28-65"><a href="#cb28-65" aria-hidden="true" tabindex="-1"></a>    <span class="at">callbacks =</span> callbacks,</span>
<span id="cb28-66"><a href="#cb28-66" aria-hidden="true" tabindex="-1"></a>    <span class="at">validation_data =</span> validation_dataset</span>
<span id="cb28-67"><a href="#cb28-67" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Kopiuj do schowka" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details open="">
<summary>Kod</summary>
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>model <span class="ot">&lt;-</span> <span class="fu">load_model_tf</span>(<span class="st">"models/vgg16_cat_dog.keras"</span>)</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"models/vgg16_cat_dog_hist.rda"</span>)</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(history)</span></code><button title="Kopiuj do schowka" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="segmentation_files/figure-html/unnamed-chunk-19-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Nasz nowy model osiąga dokładność testu 90,2%, w porównaniu z 83% dla modelu z poprzedniego rozdziału. Jak widać, stosowanie najlepszych architektur ma natychmiastowy, znaczący wpływ na wydajność modelu! Chcąc jeszcze bardziej poprawić wydajność, powinniśmy zacząć systematycznie dostrajać hiperparametry naszej architektury.</p>
</section>
</section>
<section id="co-widzi-sieć-konwolucyjna" class="level2 page-columns page-full" data-number="14.2">
<h2 data-number="14.2" class="anchored" data-anchor-id="co-widzi-sieć-konwolucyjna"><span class="header-section-number">14.2</span> Co widzi sieć konwolucyjna?</h2>
<p>Podstawowym problemem podczas budowania aplikacji wizji komputerowej jest kwestia możliwości interpretacji: dlaczego nasz klasyfikator uznał, że dany obraz zawiera lodówkę, podczas gdy wszystko, co widzimy, to ciężarówka? Jest to szczególnie istotne w przypadkach użycia, w których głębokie uczenie jest wykorzystywane do uzupełnienia ludzkiej wiedzy, jak na przykład w przypadkach użycia obrazowania medycznego. Zakończymy ten rozdział zapoznając Cię z szeregiem różnych technik wizualizacji tego, czego uczą się sieci splotowe i zrozumienia podejmowanych przez nie decyzji.</p>

<div class="no-row-height column-margin column-container"><div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://media.giphy.com/media/ZNMa7ocjGc0PTlHrP4/giphy.gif" class="img-fluid figure-img"></p>
</figure>
</div></div><p>Często mówi się, że modele głębokiego uczenia są “czarnymi skrzynkami”: uczą się reprezentacji, które są trudne do wyodrębnienia i przedstawienia w formie czytelnej dla człowieka. Chociaż jest to częściowo prawdą w przypadku niektórych typów modeli głębokiego uczenia, to zdecydowanie nie jest to prawdą w przypadku sieci splotowych. Reprezentacje uczone przez sieci konwolucyjne są wygodne w wizualizacji, w dużej mierze dlatego, że są to reprezentacje wizualnych koncepcji. Od 2013 roku opracowano szeroki wachlarz technik wizualizacji i interpretacji tych reprezentacji. Nie będziemy badać ich wszystkich, ale omówimy trzy z najbardziej przystępnych i użytecznych:</p>
<ul>
<li>Wizualizacja pośrednich wyjść sieci (pośrednich aktywacji) - przydatna do zrozumienia, jak kolejne warstwy sieci przekształcają swoje dane wejściowe, oraz do uzyskania pierwszego wyobrażenia o znaczeniu poszczególnych filtrów sieci.</li>
<li>Wizualizacja filtrów sieci splotowych - przydatna do dokładnego zrozumienia, na jaki wzór wizualny lub pojęcie reaguje każdy filtr w sieci.</li>
<li>Wizualizacja map ciepła aktywacji klas w obrazie - przydatna do zrozumienia, które części obrazu zostały zidentyfikowane jako należące do danej klasy, co pozwala na lokalizację obiektów w obrazach.</li>
</ul>
<p>Do pierwszej metody - wizualizacji aktywacji - użyjemy małej sieci, którą wytrenowaliśmy od podstaw na problemie klasyfikacji psy-vs-koty. W przypadku dwóch kolejnych metod użyjemy wstępnie wytrenowanego modelu Xception.</p>
<section id="wizualizacja-aktywacji-pośrednich" class="level4 page-columns page-full" data-number="14.2.0.1">
<h4 data-number="14.2.0.1" class="anchored" data-anchor-id="wizualizacja-aktywacji-pośrednich"><span class="header-section-number">14.2.0.1</span> Wizualizacja aktywacji pośrednich</h4>
<p>Wizualizacja pośrednich aktywacji polega na wyświetleniu wartości zwracanych przez różne warstwy konwolucji i łączenia w modelu, przy określonym wejściu (wyjście warstwy często nazywane jest jej aktywacją, wyjściem funkcji aktywacji). Daje to wgląd w to, jak dane wejściowe są rozkładane na różne filtry uczone przez sieć. Chcemy wizualizować mapy cech o trzech wymiarach: szerokości, wysokości i głębokości (kanały). Każdy kanał koduje względnie niezależne cechy, więc właściwym sposobem wizualizacji tych map cech jest niezależne wykreślenie zawartości każdego kanału jako obrazu 2D. Zacznijmy od załadowania modelu:</p>
<div class="cell">
<details open="">
<summary>Kod</summary>
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>model <span class="ot">&lt;-</span> <span class="fu">load_model_tf</span>(<span class="st">"models/convnet_from_scratch_with_augmentation.keras"</span>)</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>model</span></code><button title="Kopiuj do schowka" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Model: "model"
________________________________________________________________________________
 Layer (type)                       Output Shape                    Param #     
================================================================================
 input_1 (InputLayer)               [(None, 180, 180, 3)]           0           
 sequential (Sequential)            (None, 180, 180, 3)             0           
 rescaling (Rescaling)              (None, 180, 180, 3)             0           
 conv2d_4 (Conv2D)                  (None, 178, 178, 32)            896         
 max_pooling2d_3 (MaxPooling2D)     (None, 89, 89, 32)              0           
 conv2d_3 (Conv2D)                  (None, 87, 87, 64)              18496       
 max_pooling2d_2 (MaxPooling2D)     (None, 43, 43, 64)              0           
 conv2d_2 (Conv2D)                  (None, 41, 41, 128)             73856       
 max_pooling2d_1 (MaxPooling2D)     (None, 20, 20, 128)             0           
 conv2d_1 (Conv2D)                  (None, 18, 18, 256)             295168      
 max_pooling2d (MaxPooling2D)       (None, 9, 9, 256)               0           
 conv2d (Conv2D)                    (None, 7, 7, 256)               590080      
 flatten (Flatten)                  (None, 12544)                   0           
 dropout (Dropout)                  (None, 12544)                   0           
 dense (Dense)                      (None, 1)                       12545       
================================================================================
Total params: 991,041
Trainable params: 991,041
Non-trainable params: 0
________________________________________________________________________________</code></pre>
</div>
</div>
<p>Następnie pobieramy obraz wejściowy - zdjęcie kota, które nie jest częścią obrazów, na których sieć była trenowana.</p>
<div class="cell">
<details open="">
<summary>Kod</summary>
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>img_path <span class="ot">&lt;-</span> <span class="fu">get_file</span>(</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">fname =</span> <span class="st">"cat.jpg"</span>,</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">origin =</span> <span class="st">"https://img-datasets.s3.amazonaws.com/cat.jpg"</span>)</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>img_tensor <span class="ot">&lt;-</span> img_path <span class="sc">%&gt;%</span></span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tf_read_image</span>(<span class="at">resize =</span> <span class="fu">c</span>(<span class="dv">180</span>, <span class="dv">180</span>))</span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a><span class="fu">display_image_tensor</span>(img_tensor)</span></code><button title="Kopiuj do schowka" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="segmentation_files/figure-html/unnamed-chunk-21-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Aby wyodrębnić mapy cech, które chcemy obejrzeć, stworzymy model Keras, który przyjmuje partie obrazów jako dane wejściowe i który wyprowadza aktywacje wszystkich warstw konwolucji.</p>
<div class="cell">
<details open="">
<summary>Kod</summary>
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>conv_layer_s3_classname <span class="ot">&lt;-</span> <span class="fu">class</span>(<span class="fu">layer_conv_2d</span>(<span class="cn">NULL</span>, <span class="dv">1</span>, <span class="dv">1</span>))[<span class="dv">1</span>]</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>pooling_layer_s3_classname <span class="ot">&lt;-</span> <span class="fu">class</span>(<span class="fu">layer_max_pooling_2d</span>(<span class="cn">NULL</span>))[<span class="dv">1</span>]</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>is_conv_layer <span class="ot">&lt;-</span> <span class="cf">function</span>(x) <span class="fu">inherits</span>(x, conv_layer_s3_classname)</span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>is_pooling_layer <span class="ot">&lt;-</span> <span class="cf">function</span>(x) <span class="fu">inherits</span>(x, pooling_layer_s3_classname)</span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>layer_outputs <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (layer <span class="cf">in</span> model<span class="sc">$</span>layers)</span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is_conv_layer</span>(layer) <span class="sc">||</span> <span class="fu">is_pooling_layer</span>(layer))</span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a>    layer_outputs[[layer<span class="sc">$</span>name]] <span class="ot">&lt;-</span> layer<span class="sc">$</span>output</span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a>activation_model <span class="ot">&lt;-</span> <span class="fu">keras_model</span>(<span class="at">inputs =</span> model<span class="sc">$</span>input,</span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a>                                <span class="at">outputs =</span> layer_outputs)</span></code><button title="Kopiuj do schowka" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Po podaniu obrazu wejściowego, model ten zwraca wartości aktywacji warstw w oryginalnym modelu, w postaci listy. Ten model ma jedno wejście i osiem wyjść: jedno wyjście na każdą aktywację warstwy.</p>
<div class="cell">
<details open="">
<summary>Kod</summary>
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>activations <span class="ot">&lt;-</span> activation_model <span class="sc">|&gt;</span> </span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">predict</span>(img_tensor[tf<span class="sc">$</span>newaxis,,,])</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(activations)</span></code><button title="Kopiuj do schowka" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>List of 9
 $ conv2d_4       : num [1, 1:178, 1:178, 1:32] 0 0 0 0 0 0 0 0 0 0 ...
 $ max_pooling2d_3: num [1, 1:89, 1:89, 1:32] 0 0 0 0 0 0 0 0 0 0 ...
 $ conv2d_3       : num [1, 1:87, 1:87, 1:64] 0.0393 0.0651 0.0795 0.0466 0.0943 ...
 $ max_pooling2d_2: num [1, 1:43, 1:43, 1:64] 0.0651 0.0795 0.0961 0.0799 0.1202 ...
 $ conv2d_2       : num [1, 1:41, 1:41, 1:128] 0.1349 0.1584 0.1228 0.0913 0 ...
 $ max_pooling2d_1: num [1, 1:20, 1:20, 1:128] 0.16708 0.12279 0.00736 0 0 ...
 $ conv2d_1       : num [1, 1:18, 1:18, 1:256] 0 0 0 0 0 0 0 0 0 0 ...
 $ max_pooling2d  : num [1, 1:9, 1:9, 1:256] 0 0 0 0 0 0 0 0 0 0 ...
 $ conv2d         : num [1, 1:7, 1:7, 1:256] 0 0 0 0 0.102 ...</code></pre>
</div>
</div>
<p>Przyjrzyjmy się bliżej aktywacjom pierwszej warstwy.</p>
<div class="cell">
<details open="">
<summary>Kod</summary>
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>first_layer_activation <span class="ot">&lt;-</span> activations[[<span class="fu">names</span>(layer_outputs)[<span class="dv">1</span>]]]</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(first_layer_activation)</span></code><button title="Kopiuj do schowka" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1]   1 178 178  32</code></pre>
</div>
</div>
<p>Jest to mapa funkcji o wymiarach 178 × 178 z 32 kanałami. Spróbujmy wykreślić trzeci kanał aktywacji pierwszej warstwy oryginalnego modelu (patrz <a href="#fig-seg9">Rysunek&nbsp;<span>14.9</span></a>).</p>
<div class="cell">
<details open="">
<summary>Kod</summary>
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>plot_activations <span class="ot">&lt;-</span> <span class="cf">function</span>(x, ...) {</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">as.array</span>(x)</span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">sum</span>(x) <span class="sc">==</span> <span class="dv">0</span>)</span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(<span class="fu">plot</span>(<span class="fu">as.raster</span>(<span class="st">"gray"</span>)))</span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a>  rotate <span class="ot">&lt;-</span> <span class="cf">function</span>(x) <span class="fu">t</span>(<span class="fu">apply</span>(x, <span class="dv">2</span>, rev))</span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">image</span>(<span class="fu">rotate</span>(x), <span class="at">asp =</span> <span class="dv">1</span>, <span class="at">axes =</span> <span class="cn">FALSE</span>, <span class="at">useRaster =</span> <span class="cn">TRUE</span>,</span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a>        <span class="at">col =</span> <span class="fu">terrain.colors</span>(<span class="dv">256</span>), ...)</span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb38-12"><a href="#cb38-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-13"><a href="#cb38-13" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_activations</span>(first_layer_activation[, , , <span class="dv">3</span>])</span></code><button title="Kopiuj do schowka" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-seg9" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="segmentation_files/figure-html/fig-seg9-1.png" class="img-fluid figure-img" width="672"></p>
<p></p><figcaption class="figure-caption">Rysunek&nbsp;14.9: Wykres wartości trzeciego kanału pierwszej warstwy aktywacji</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>Kanał ten wydaje się kodować krawędzi ukośne - ale zauważmy, że nasze kanały mogą się różnić, ponieważ konkretne filtry uczone przez warstwy konwolucji nie są deterministyczne.</p>
<p>Wykreślmy teraz pełną wizualizację wszystkich aktywacji w sieci. Wyodrębnimy i wykreślimy każdy kanał w każdej z warstw aktywacji, a następnie ułożymy wyniki w jedną dużą siatkę, z kanałami ułożonymi obok siebie.</p>
<div class="cell">
<details open="">
<summary>Kod</summary>
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (layer_name <span class="cf">in</span> <span class="fu">names</span>(layer_outputs)) {</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>  layer_output <span class="ot">&lt;-</span> activations[[layer_name]]</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>  n_features <span class="ot">&lt;-</span> <span class="fu">dim</span>(layer_output) <span class="sc">%&gt;%</span> <span class="fu">tail</span>(<span class="dv">1</span>)</span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">n2mfrow</span>(n_features, <span class="at">asp =</span> <span class="fl">1.75</span>),</span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>      <span class="at">mar =</span> <span class="fu">rep</span>(.<span class="dv">1</span>, <span class="dv">4</span>), <span class="at">oma =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="fl">1.5</span>, <span class="dv">0</span>))</span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n_features)</span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">plot_activations</span>(layer_output[, , , j])</span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">title</span>(<span class="at">main =</span> layer_name, <span class="at">outer =</span> <span class="cn">TRUE</span>)</span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Kopiuj do schowka" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="segmentation_files/figure-html/unnamed-chunk-26-1.png" class="img-fluid" width="672"></p>
</div>
<div class="cell-output-display">
<p><img src="segmentation_files/figure-html/unnamed-chunk-26-2.png" class="img-fluid" width="672"></p>
</div>
<div class="cell-output-display">
<p><img src="segmentation_files/figure-html/unnamed-chunk-26-3.png" class="img-fluid" width="672"></p>
</div>
<div class="cell-output-display">
<p><img src="segmentation_files/figure-html/unnamed-chunk-26-4.png" class="img-fluid" width="672"></p>
</div>
<div class="cell-output-display">
<p><img src="segmentation_files/figure-html/unnamed-chunk-26-5.png" class="img-fluid" width="672"></p>
</div>
<div class="cell-output-display">
<p><img src="segmentation_files/figure-html/unnamed-chunk-26-6.png" class="img-fluid" width="672"></p>
</div>
<div class="cell-output-display">
<p><img src="segmentation_files/figure-html/unnamed-chunk-26-7.png" class="img-fluid" width="672"></p>
</div>
<div class="cell-output-display">
<p><img src="segmentation_files/figure-html/unnamed-chunk-26-8.png" class="img-fluid" width="672"></p>
</div>
<div class="cell-output-display">
<p><img src="segmentation_files/figure-html/unnamed-chunk-26-9.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Należy tu zwrócić uwagę na kilka rzeczy:</p>
<ul>
<li>Pierwsza warstwa działa jako zbiór różnych detektorów krawędzi. Na tym etapie, aktywacje zachowują prawie wszystkie informacje obecne na początkowym obrazie.</li>
<li>W miarę zagłębiania się, aktywacje stają się coraz bardziej abstrakcyjne i mniej wizualnie interpretowalne. Zaczynają kodować pojęcia wyższego rzędu, takie jak “kocie ucho” czy “kocie oko”. Głębsze prezentacje niosą coraz mniej informacji o wizualnej zawartości obrazu, a coraz więcej informacji związanych z klasą obrazu.</li>
<li>Rozproszenie aktywacji rośnie wraz z głębokością warstwy: w pierwszej warstwie prawie wszystkie filtry są aktywowane przez obraz wejściowy, ale w kolejnych warstwach coraz więcej filtrów jest pustych. Oznacza to, że wzór zakodowany przez filtr nie występuje na obrazie wejściowym.</li>
</ul>
<p>Wykazaliśmy właśnie ważną, uniwersalną cechę reprezentacji uczonych przez głębokie sieci neuronowe: cechy wydobywane przez warstwę stają się coraz bardziej abstrakcyjne wraz z głębokością warstwy. Aktywacje wyższych warstw niosą coraz mniej informacji o konkretnym widzianym wejściu, a coraz więcej informacji o celu (w tym przypadku klasie obrazu: kot czy pies). Głęboka sieć neuronowa działa jak przebieg destylacji informacji, w którym surowe dane (w tym przypadku obrazy RGB) są wielokrotnie przekształcane w taki sposób, że nieistotne informacje są odfiltrowywane (np. specyficzny wygląd wizualny obrazu), a użyteczne informacje są eksponowane i udoskonalane.</p>

<div class="no-row-height column-margin column-container"><div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://media.giphy.com/media/l46CuDUhXNUx1Bm5G/giphy.gif" class="img-fluid figure-img" width="400"></p>
</figure>
</div></div><p>Jest to podobne do sposobu, w jaki ludzie i zwierzęta postrzegają świat: po obserwacji sceny przez kilka sekund człowiek może pamiętać, jakie abstrakcyjne obiekty były w niej obecne (rower, drzewo), ale może nie pamiętać konkretnego wyglądu tych obiektów. W rzeczywistości, gdybyśmy próbowali narysować z pamięci ogólny rower, istnieje prawdopodobieństwo, że nie udałoby się to nawet w najmniejszym stopniu, mimo że w swoim życiu widzieliśmy tysiące rowerów. Nasz mózg nauczył się całkowicie abstrahować od informacji wizualnych - przekształcać je w wysokopoziomowe koncepcje wizualne, jednocześnie odfiltrowując nieistotne szczegóły wizualne - co sprawia, że zapamiętanie wyglądu rzeczy wokół nas jest niezwykle trudne.</p>
</section>
<section id="wizualizacja-filtrów-sieci-splotowych" class="level4" data-number="14.2.0.2">
<h4 data-number="14.2.0.2" class="anchored" data-anchor-id="wizualizacja-filtrów-sieci-splotowych"><span class="header-section-number">14.2.0.2</span> Wizualizacja filtrów sieci splotowych</h4>
<p>Innym prostym sposobem na sprawdzenie filtrów wyuczonych przez sieci splotowe jest wyświetlenie wzorca wizualnego, na który każdy filtr ma reagować. Można to zrobić za pomocą spadku gradientu w przestrzeni wejściowej: zastosowanie spadku gradientu do wartości obrazu wejściowego sieci splotowej tak, aby zmaksymalizować odpowiedź określonego filtra, zaczynając od pustego obrazu wejściowego. Wynikowy obraz wejściowy będzie taki, na który wybrany filtr maksymalnie reaguje.</p>
<p>Spróbujmy to zrobić z filtrami modelu Xception, wytrenowanego na <em>ImageNet</em>. Proces jest prosty: zbudujemy funkcję straty, która maksymalizuje wartość danego filtra w danej warstwie konwolucji, a następnie użyjemy stochastycznego spadku gradientu, aby dopasować wartości obrazu wejściowego tak, by zmaksymalizować tę wartość aktywacji. Najpierw zainicjujmy model Xception, załadowany wagami wytrenowanymi na zbiorze danych <em>ImageNet</em>.</p>
<div class="cell">
<details open="">
<summary>Kod</summary>
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>model <span class="ot">&lt;-</span> <span class="fu">application_xception</span>(</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">weights =</span> <span class="st">"imagenet"</span>,</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">include_top =</span> <span class="cn">FALSE</span></span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Kopiuj do schowka" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Interesują nas warstwy konwolucyjne modelu - Conv2D i SeparableConv2D. Musimy znać ich nazwy, aby móc pobrać ich dane wyjściowe. Wypiszmy ich nazwy, w kolejności głębokości.</p>
<div class="cell">
<details open="">
<summary>Kod</summary>
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (layer <span class="cf">in</span> model<span class="sc">$</span>layers)</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a> <span class="cf">if</span>(<span class="fu">any</span>(<span class="fu">grepl</span>(<span class="st">"Conv2D"</span>, <span class="fu">class</span>(layer))))</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>   <span class="fu">print</span>(layer<span class="sc">$</span>name)</span></code><button title="Kopiuj do schowka" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "block1_conv1"
[1] "block1_conv2"
[1] "block2_sepconv1"
[1] "block2_sepconv2"
[1] "conv2d_23"
[1] "block3_sepconv1"
[1] "block3_sepconv2"
[1] "conv2d_24"
[1] "block4_sepconv1"
[1] "block4_sepconv2"
[1] "conv2d_25"
[1] "block5_sepconv1"
[1] "block5_sepconv2"
[1] "block5_sepconv3"
[1] "block6_sepconv1"
[1] "block6_sepconv2"
[1] "block6_sepconv3"
[1] "block7_sepconv1"
[1] "block7_sepconv2"
[1] "block7_sepconv3"
[1] "block8_sepconv1"
[1] "block8_sepconv2"
[1] "block8_sepconv3"
[1] "block9_sepconv1"
[1] "block9_sepconv2"
[1] "block9_sepconv3"
[1] "block10_sepconv1"
[1] "block10_sepconv2"
[1] "block10_sepconv3"
[1] "block11_sepconv1"
[1] "block11_sepconv2"
[1] "block11_sepconv3"
[1] "block12_sepconv1"
[1] "block12_sepconv2"
[1] "block12_sepconv3"
[1] "block13_sepconv1"
[1] "block13_sepconv2"
[1] "conv2d_26"
[1] "block14_sepconv1"
[1] "block14_sepconv2"</code></pre>
</div>
</div>
<p>Zauważmy, że separowalne warstwy <code>conv2D</code> tutaj są nazwane <code>block6_sepconv1</code>, <code>block7_sepconv2</code>, i tak dalej. Xception jest zorganizowany w bloki, z których każdy zawiera kilka warstw konwolucyjnych. Teraz stwórzmy drugi model, który zwraca wyjście konkretnej warstwy - model ekstraktora cech. Ponieważ nasz model jest modelem zbudowanym za pomocą API, jest on inspekcyjny: możemy zapytać o wyjście jednej z jego warstw i ponownie użyć go w nowym modelu. Nie trzeba kopiować całego kodu Xception.</p>
<div class="cell">
<details open="">
<summary>Kod</summary>
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>layer_name <span class="ot">&lt;-</span> <span class="st">"block3_sepconv1"</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>layer <span class="ot">&lt;-</span> model <span class="sc">%&gt;%</span> keras<span class="sc">::</span><span class="fu">get_layer</span>(<span class="at">name =</span> layer_name)</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>feature_extractor <span class="ot">&lt;-</span> <span class="fu">keras_model</span>(<span class="at">inputs =</span> model<span class="sc">$</span>input,</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">outputs =</span> layer<span class="sc">$</span>output)</span></code><button title="Kopiuj do schowka" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Aby użyć ekstraktora, wystarczy wywołać go na jakichś danych wejściowych (zauważmy, że Xception wymaga, aby dane wejściowe były wstępnie przetworzone za pomocą funkcji <code>xception_preprocess_input()</code>).</p>
<div class="cell">
<details open="">
<summary>Kod</summary>
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>activation <span class="ot">&lt;-</span> img_tensor <span class="sc">%&gt;%</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>   .[tf<span class="sc">$</span>newaxis, , , ] <span class="sc">%&gt;%</span></span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>   <span class="fu">xception_preprocess_input</span>() <span class="sc">%&gt;%</span></span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>   <span class="fu">feature_extractor</span>()</span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(activation)</span></code><button title="Kopiuj do schowka" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;tf.Tensor: shape=(1, 44, 44, 256), dtype=float32, numpy=…&gt;</code></pre>
</div>
</div>
<p>Użyjmy naszego modelu ekstraktora cech do zdefiniowania funkcji, która zwraca wartość skalarną określającą, jak bardzo dany obraz wejściowy “aktywuje” dany filtr w warstwie. Jest to “funkcja straty”, którą będziemy maksymalizować podczas procesu wznoszenia gradientu:</p>
<div class="cell">
<details open="">
<summary>Kod</summary>
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>compute_loss <span class="ot">&lt;-</span> <span class="cf">function</span>(image, filter_index) {</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>  activation <span class="ot">&lt;-</span> <span class="fu">feature_extractor</span>(image)</span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>  filter_index <span class="ot">&lt;-</span> <span class="fu">as_tensor</span>(filter_index, <span class="st">"int32"</span>)</span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a>  filter_activation <span class="ot">&lt;-</span></span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a>      activation[, , , filter_index, style <span class="ot">=</span> <span class="st">"python"</span>] <span class="co"># aby program wiedział, że kodowanie pierwszego indeksu zaczyna się od 0 - jak w Python</span></span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mean</span>(filter_activation[, <span class="dv">3</span><span class="sc">:-</span><span class="dv">3</span>, <span class="dv">3</span><span class="sc">:-</span><span class="dv">3</span>])</span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Kopiuj do schowka" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Ustawmy funkcję krokową gradientu zstępującego, korzystając z funkcji <code>GradientTape()</code>. Nieoczywistą sztuczką pomagającą w płynnym przebiegu procesu spadku gradientu jest normalizacja tensora gradientu poprzez podzielenie go przez jego normę L2 (pierwiastek kwadratowy ze średniej kwadratowej wartości w tensorze). Dzięki temu wielkość aktualizacji obrazu wejściowego jest zawsze w tym samym zakresie.</p>
<div class="cell">
<details open="">
<summary>Kod</summary>
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>gradient_ascent_step <span class="ot">&lt;-</span></span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">function</span>(image, filter_index, learning_rate) {</span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">with</span>(tf<span class="sc">$</span><span class="fu">GradientTape</span>() <span class="sc">%as%</span> tape, {</span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>      tape<span class="sc">$</span><span class="fu">watch</span>(image)</span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a>      loss <span class="ot">&lt;-</span> <span class="fu">compute_loss</span>(image, filter_index)</span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a>    grads <span class="ot">&lt;-</span> tape<span class="sc">$</span><span class="fu">gradient</span>(loss, image)</span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a>    grads <span class="ot">&lt;-</span> tf<span class="sc">$</span>math<span class="sc">$</span><span class="fu">l2_normalize</span>(grads)</span>
<span id="cb47-9"><a href="#cb47-9" aria-hidden="true" tabindex="-1"></a>    image <span class="sc">+</span> (learning_rate <span class="sc">*</span> grads)</span>
<span id="cb47-10"><a href="#cb47-10" aria-hidden="true" tabindex="-1"></a>  }</span></code><button title="Kopiuj do schowka" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Teraz mamy już wszystkie elementy. Połączmy je w funkcję R, która pobiera jako dane wejściowe nazwę warstwy i indeks filtra i zwraca tensor reprezentujący wzór, który maksymalizuje aktywację określonego filtra. Zauważmy, że użyjemy funkcji <code>tf_function()</code>, aby przyspieszyć działanie.</p>
<div class="cell">
<details open="">
<summary>Kod</summary>
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="fu">c</span>(img_width, img_height) <span class="sc">%&lt;-%</span> <span class="fu">c</span>(<span class="dv">200</span>, <span class="dv">200</span>)</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>generate_filter_pattern <span class="ot">&lt;-</span> <span class="fu">tf_function</span>(<span class="cf">function</span>(filter_index) {</span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a>  iterations <span class="ot">&lt;-</span> <span class="dv">30</span></span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a>  learning_rate <span class="ot">&lt;-</span> <span class="dv">10</span></span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a>  image <span class="ot">&lt;-</span> tf<span class="sc">$</span>random<span class="sc">$</span><span class="fu">uniform</span>(</span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">minval =</span> <span class="fl">0.4</span>, <span class="at">maxval =</span> <span class="fl">0.6</span>,</span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">shape =</span> <span class="fu">shape</span>(<span class="dv">1</span>, img_width, img_height, <span class="dv">3</span>)</span>
<span id="cb48-9"><a href="#cb48-9" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb48-10"><a href="#cb48-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-11"><a href="#cb48-11" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq</span>(iterations))</span>
<span id="cb48-12"><a href="#cb48-12" aria-hidden="true" tabindex="-1"></a>      image <span class="ot">&lt;-</span> <span class="fu">gradient_ascent_step</span>(image, filter_index, learning_rate)</span>
<span id="cb48-13"><a href="#cb48-13" aria-hidden="true" tabindex="-1"></a>  image[<span class="dv">1</span>, , , ]</span>
<span id="cb48-14"><a href="#cb48-14" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Kopiuj do schowka" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Wynikowy tensor obrazu jest tablicą zmiennoprzecinkową o kształcie (200, 200, 3), z wartościami, które nie mogą być liczbami całkowitymi z zakresu [0, 255]. Dlatego też musimy poddać ten tensor postprocessingowi, aby przekształcić go w obraz możliwy do wyświetlenia. Zrobimy to za pomocą operacji na tensorach i zawiniemy w <code>tf_function()</code>, aby również przyspieszyć.</p>
<div class="cell">
<details open="">
<summary>Kod</summary>
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>deprocess_image <span class="ot">&lt;-</span> <span class="fu">tf_function</span>(<span class="cf">function</span>(image, <span class="at">crop =</span> <span class="cn">TRUE</span>) {</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>  image <span class="ot">&lt;-</span> image <span class="sc">-</span> <span class="fu">mean</span>(image)</span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>  image <span class="ot">&lt;-</span> image <span class="sc">/</span> tf<span class="sc">$</span>math<span class="sc">$</span><span class="fu">reduce_std</span>(image)</span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>  image <span class="ot">&lt;-</span> (image <span class="sc">*</span> <span class="dv">64</span>) <span class="sc">+</span> <span class="dv">128</span></span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a>  image <span class="ot">&lt;-</span> tf<span class="sc">$</span><span class="fu">clip_by_value</span>(image, <span class="dv">0</span>, <span class="dv">255</span>)</span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(crop)</span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a>    image <span class="ot">&lt;-</span> image[<span class="dv">26</span><span class="sc">:-</span><span class="dv">26</span>, <span class="dv">26</span><span class="sc">:-</span><span class="dv">26</span>, ]</span>
<span id="cb49-8"><a href="#cb49-8" aria-hidden="true" tabindex="-1"></a>  image</span>
<span id="cb49-9"><a href="#cb49-9" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb49-10"><a href="#cb49-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-11"><a href="#cb49-11" aria-hidden="true" tabindex="-1"></a><span class="fu">generate_filter_pattern</span>(<span class="at">filter_index =</span> <span class="fu">as_tensor</span>(2L)) <span class="sc">%&gt;%</span></span>
<span id="cb49-12"><a href="#cb49-12" aria-hidden="true" tabindex="-1"></a> <span class="fu">deprocess_image</span>() <span class="sc">%&gt;%</span></span>
<span id="cb49-13"><a href="#cb49-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">display_image_tensor</span>()</span></code><button title="Kopiuj do schowka" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="segmentation_files/figure-html/unnamed-chunk-34-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Zauważmy, że złożyliśmy tutaj <code>filter_index</code> z <code>as_tensor()</code>. Robimy to, ponieważ <code>tf_funkcja()</code> kompiluje oddzielną zoptymalizowaną funkcję dla każdego unikalnego sposobu jej wywoływana, a różne stałe liczą się jako unikalna sygnatura wywołania. Wygląda na to, że trzeci filtr w warstwie <code>block3_sepconv1</code> reaguje na wzór poziomych linii, nieco przypominający wodę.</p>
<div class="cell">
<details open="">
<summary>Kod</summary>
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">8</span>, <span class="dv">8</span>))</span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">63</span>)) {</span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">generate_filter_pattern</span>(<span class="at">filter_index =</span> <span class="fu">as_tensor</span>(i)) <span class="sc">%&gt;%</span></span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">deprocess_image</span>() <span class="sc">%&gt;%</span></span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">display_image_tensor</span>(<span class="at">plot_margins =</span> <span class="fu">rep</span>(.<span class="dv">1</span>, <span class="dv">4</span>))</span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Kopiuj do schowka" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-seg11" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="segmentation_files/figure-html/fig-seg11-1.png" class="img-fluid figure-img" width="672"></p>
<p></p><figcaption class="figure-caption">Rysunek&nbsp;14.10: Kilka wzorów filtrów dla warstw <code>block2_sepconv1</code>, <code>block4_sepconv1</code> i <code>block8_sepconv1</code></figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>Te wizualizacje filtrów (patrz <a href="#fig-seg11">Rysunek&nbsp;<span>14.10</span></a>) mówią wiele o tym, jak warstwy sieci splotowej widzą świat: każda warstwa w sieci splotowej uczy się zbioru filtrów w taki sposób, że jej dane wejściowe mogą być wyrażone jako kombinacja filtrów. Jest to podobne do tego, jak transformata Fouriera rozkłada sygnały na funkcje trygonometryczne. Filtry w tych blokach filtrów sieci splotowej stają się coraz bardziej złożone i wyrafinowane, gdy zagłębiamy się w model:</p>
<ul>
<li>Filtry z pierwszych warstw w modelu kodują proste krawędzie kierunkowe i kolory (lub kolorowe krawędzie, w niektórych przypadkach).</li>
<li>Filtry z warstw położonych nieco dalej w górę stosu, takich jak <code>block4_sepconv1</code>, kodują proste tekstury wykonane z kombinacji krawędzi i kolorów.</li>
<li>Filtry z wyższych warstw zaczynają przypominać tekstury występujące w naturalnych obrazach: pióra, oczy, liście i tak dalej.</li>
</ul>
</section>
<section id="wizualizacja-map-ciepła-aktywacji-klasowych" class="level4 page-columns page-full" data-number="14.2.0.3">
<h4 data-number="14.2.0.3" class="anchored" data-anchor-id="wizualizacja-map-ciepła-aktywacji-klasowych"><span class="header-section-number">14.2.0.3</span> Wizualizacja map ciepła aktywacji klasowych</h4>
<p>Przedstawimy jeszcze jedną technikę wizualizacji - przydatną do zrozumienia, które części danego obrazu doprowadziły sieci splotowe do ostatecznej decyzji klasyfikacyjnej. Jest to pomocne w “debugowaniu” procesu decyzyjnego sieci konwolucyjnych, szczególnie w przypadku błędu klasyfikacji (problem nazywany interpretacją modelu). Może to również pozwolić na zlokalizowanie konkretnych obiektów na obrazie.</p>

<div class="no-row-height column-margin column-container"><div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://media.giphy.com/media/VFSexwZVYCeuDwqRF5/giphy.gif" class="img-fluid figure-img" width="400"></p>
</figure>
</div></div><p>Ta ogólna kategoria technik nazywana jest wizualizacją mapy aktywacji klas (ang. <em>Class Activation Map -</em> CAM) i polega na tworzeniu map ciepła aktywacji klas na obrazach wejściowych. Mapa ciepła aktywacji klas to dwuwymiarowa siatka wyników związanych z konkretną klasą wyjściową, obliczona dla każdej lokalizacji na dowolnym obrazie wejściowym, wskazująca jak ważna jest każda lokalizacja w odniesieniu do rozważanej klasy. Na przykład, biorąc pod uwagę obrazek wprowadzony do sieci splotowej psy-vs-koty, wizualizacja CAM pozwoli nam wygenerować mapę ciepła dla klasy “kot”, wskazując jak podobne do kotów są różne części obrazka, a także mapę ciepła dla klasy “pies”, wskazując jak podobne do psów są części obrazka.</p>
<p>Konkretna implementacja, której użyjemy, to ta opisana w artykule zatytułowanym “Grad-CAM: Visual Explanations from Deep Networks via Gradient-based Localization”<span class="citation" data-cites="selvarajuGradCAMVisualExplanations2020">(<a href="references.html#ref-selvarajuGradCAMVisualExplanations2020" role="doc-biblioref">Selvaraju i in. 2020</a>)</span>.</p>
<p>Grad-CAM polega na tym, że bierzemy wyjściową mapę cech warstwy konwolucji, daną obrazowi wejściowemu, i ważymy każdy kanał w tej mapie cech przez gradient klasy względem kanału. Intuicyjnie, jednym ze sposobów zrozumienia tej sztuczki jest wyobrażenie sobie, że ważymy przestrzenną mapę “jak intensywnie obraz wejściowy aktywuje różne kanały” przez “jak ważny jest każdy kanał w odniesieniu do klasy”, w wyniku czego otrzymujemy przestrzenną mapę “jak intensywnie obraz wejściowy aktywuje klasę”. Zademonstrujmy tę technikę przy użyciu wstępnie wytrenowanego modelu Xception.</p>
<div class="cell">
<details open="">
<summary>Kod</summary>
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>model <span class="ot">&lt;-</span> <span class="fu">application_xception</span>(<span class="at">weights =</span> <span class="st">"imagenet"</span>)</span></code><button title="Kopiuj do schowka" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Rozważmy obraz dwóch słoni afrykańskich pokazany na <a href="#fig-seg12">Rysunek&nbsp;<span>14.11</span></a>. Przekształćmy ten obraz w coś, co model Xception może odczytać: model był trenowany na obrazach o rozmiarze 299 × 299, wstępnie przetworzonych zgodnie z kilkoma regułami, które są spakowane w funkcji użytkowej <code>xception_preprocess_input()</code>.</p>
<div class="cell">
<details open="">
<summary>Kod</summary>
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>img_path <span class="ot">&lt;-</span> <span class="fu">get_file</span>(</span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">fname =</span> <span class="st">"elephant.jpg"</span>,</span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">origin =</span> <span class="st">"https://img-datasets.s3.amazonaws.com/elephant.jpg"</span>)</span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a>img_tensor <span class="ot">&lt;-</span> <span class="fu">tf_read_image</span>(img_path, <span class="at">resize =</span> <span class="fu">c</span>(<span class="dv">299</span>, <span class="dv">299</span>))</span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a>preprocessed_img <span class="ot">&lt;-</span> img_tensor[tf<span class="sc">$</span>newaxis, , , ] <span class="sc">%&gt;%</span></span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xception_preprocess_input</span>()</span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-8"><a href="#cb52-8" aria-hidden="true" tabindex="-1"></a><span class="fu">display_image_tensor</span>(img_tensor)</span></code><button title="Kopiuj do schowka" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-seg12" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="segmentation_files/figure-html/fig-seg12-1.png" class="img-fluid figure-img" width="672"></p>
<p></p><figcaption class="figure-caption">Rysunek&nbsp;14.11: Przykładowy obraz słoni</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>Możemy teraz uruchomić wstępnie wytrenowaną sieć na obrazie i zdekodować jej wektor predykcji z powrotem do formatu czytelnego dla człowieka:</p>
<div class="cell">
<details open="">
<summary>Kod</summary>
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>preds <span class="ot">&lt;-</span> <span class="fu">predict</span>(model, preprocessed_img)</span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(preds)</span></code><button title="Kopiuj do schowka" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code> num [1, 1:1000] 5.51e-06 2.75e-05 1.73e-05 1.19e-05 1.15e-05 ...</code></pre>
</div>
<details open="">
<summary>Kod</summary>
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="fu">imagenet_decode_predictions</span>(preds, <span class="at">top=</span><span class="dv">3</span>)[[<span class="dv">1</span>]]</span></code><button title="Kopiuj do schowka" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>  class_name class_description      score
1  n02504458  African_elephant 0.90519816
2  n01871265            tusker 0.05259845
3  n02504013   Indian_elephant 0.01615973</code></pre>
</div>
</div>
<p>Trzy najlepsze klasy przewidywane dla tego obrazu to:</p>
<ul>
<li>Słoń afrykański (z 90% prawdopodobieństwem)</li>
<li>Tusker (z 5% prawdopodobieństwem)</li>
<li>Słoń indyjski (z niemal 2% prawdopodobieństwem)</li>
</ul>
<p>Sieć rozpoznała obraz jako zawierający nieokreśloną ilość słoni afrykańskich. Wpisem w wektorze predykcji, który został maksymalnie aktywowany, jest wpis odpowiadający klasie “słoń afrykański”, o indeksie 387:</p>
<div class="cell">
<details open="">
<summary>Kod</summary>
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="fu">which.max</span>(preds[<span class="dv">1</span>, ])</span></code><button title="Kopiuj do schowka" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 387</code></pre>
</div>
</div>
<p>Aby zwizualizować, które części obrazu są najbardziej podobne do afrykańskich słoni, skonfigurujmy proces Grad-CAM. Najpierw tworzymy model, który mapuje obraz wejściowy na aktywacje ostatniej warstwy konwolucyjnej.</p>
<div class="cell">
<details open="">
<summary>Kod</summary>
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>last_conv_layer_name <span class="ot">&lt;-</span> <span class="st">"block14_sepconv2_act"</span></span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>classifier_layer_names <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"avg_pool"</span>, <span class="st">"predictions"</span>)</span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a>last_conv_layer <span class="ot">&lt;-</span> model <span class="sc">%&gt;%</span> <span class="fu">get_layer</span>(last_conv_layer_name)</span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a>last_conv_layer_model <span class="ot">&lt;-</span> <span class="fu">keras_model</span>(model<span class="sc">$</span>inputs,</span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a>                                     last_conv_layer<span class="sc">$</span>output)</span></code><button title="Kopiuj do schowka" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Po drugie, tworzymy model, który odwzorowuje aktywacje ostatniej warstwy konwolucyjnej na końcowe predykcje klas.</p>
<div class="cell">
<details open="">
<summary>Kod</summary>
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a>classifier_input <span class="ot">&lt;-</span> <span class="fu">layer_input</span>(<span class="at">batch_shape =</span> last_conv_layer<span class="sc">$</span>output<span class="sc">$</span>shape)</span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> classifier_input</span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (layer_name <span class="cf">in</span> classifier_layer_names)</span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a> x <span class="ot">&lt;-</span> <span class="fu">get_layer</span>(model, layer_name)(x)</span>
<span id="cb60-6"><a href="#cb60-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-7"><a href="#cb60-7" aria-hidden="true" tabindex="-1"></a>classifier_model <span class="ot">&lt;-</span> <span class="fu">keras_model</span>(classifier_input, x)</span></code><button title="Kopiuj do schowka" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Następnie obliczamy gradient najwyższej przewidywanej klasy dla naszego obrazu wejściowego w odniesieniu do aktywacji ostatniej warstwy konwolucji.</p>
<div class="cell">
<details open="">
<summary>Kod</summary>
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="fu">with</span> (tf<span class="sc">$</span><span class="fu">GradientTape</span>() <span class="sc">%as%</span> tape, {</span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a>  last_conv_layer_output <span class="ot">&lt;-</span> <span class="fu">last_conv_layer_model</span>(preprocessed_img)</span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a>  tape<span class="sc">$</span><span class="fu">watch</span>(last_conv_layer_output)</span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a>  preds <span class="ot">&lt;-</span> <span class="fu">classifier_model</span>(last_conv_layer_output)</span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a>  top_pred_index <span class="ot">&lt;-</span> tf<span class="sc">$</span><span class="fu">argmax</span>(preds[<span class="dv">1</span>, ])</span>
<span id="cb61-6"><a href="#cb61-6" aria-hidden="true" tabindex="-1"></a>  top_class_channel <span class="ot">&lt;-</span> preds[, top_pred_index, style <span class="ot">=</span> <span class="st">"python"</span>]</span>
<span id="cb61-7"><a href="#cb61-7" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb61-8"><a href="#cb61-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-9"><a href="#cb61-9" aria-hidden="true" tabindex="-1"></a>grads <span class="ot">&lt;-</span> tape<span class="sc">$</span><span class="fu">gradient</span>(top_class_channel, last_conv_layer_output)</span></code><button title="Kopiuj do schowka" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Teraz zastosujemy łączenie i ważenie ważności do tensora gradientu, aby uzyskać naszą mapę ciepła aktywacji klas.</p>
<div class="cell">
<details open="">
<summary>Kod</summary>
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a>pooled_grads <span class="ot">&lt;-</span> <span class="fu">mean</span>(grads, <span class="at">axis =</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>), <span class="at">keepdims =</span> T)</span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a>heatmap <span class="ot">&lt;-</span> (last_conv_layer_output <span class="sc">*</span> pooled_grads) <span class="sc">|&gt;</span> </span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mean</span>(<span class="at">axis =</span> <span class="sc">-</span><span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a>  .[<span class="dv">1</span>,,]</span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-6"><a href="#cb62-6" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mar =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>))</span>
<span id="cb62-7"><a href="#cb62-7" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_activations</span>(heatmap)</span></code><button title="Kopiuj do schowka" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="segmentation_files/figure-html/unnamed-chunk-43-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Na koniec, nałóżmy mapę ciepła aktywacji na oryginalny obraz. Wycinamy wartości mapy ciepła do palety kolorów, a następnie konwertujemy do obiektu rastrowego R. Zwróćmy uwagę, że upewniliśmy się, że przekazaliśmy <code>alfa = .4</code> do palety, tak abyśmy nadal widzieli oryginalny obraz, gdy nałożymy na niego mapę ciepła (Zobacz <a href="#fig-seg13">Rysunek&nbsp;<span>14.12</span></a>).</p>
<div class="cell">
<details open="">
<summary>Kod</summary>
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>pal <span class="ot">&lt;-</span> <span class="fu">hcl.colors</span>(<span class="dv">256</span>, <span class="at">palette =</span> <span class="st">"Spectral"</span>, <span class="at">alpha =</span> .<span class="dv">4</span>, <span class="at">rev =</span> <span class="cn">TRUE</span>)</span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>heatmap <span class="ot">&lt;-</span> <span class="fu">as.array</span>(heatmap)</span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a>heatmap[] <span class="ot">&lt;-</span> pal[<span class="fu">cut</span>(heatmap, <span class="dv">256</span>)]</span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a>heatmap <span class="ot">&lt;-</span> <span class="fu">as.raster</span>(heatmap)</span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-6"><a href="#cb63-6" aria-hidden="true" tabindex="-1"></a>img <span class="ot">&lt;-</span> <span class="fu">tf_read_image</span>(img_path, <span class="at">resize =</span> <span class="cn">NULL</span>)</span>
<span id="cb63-7"><a href="#cb63-7" aria-hidden="true" tabindex="-1"></a><span class="fu">display_image_tensor</span>(img)</span>
<span id="cb63-8"><a href="#cb63-8" aria-hidden="true" tabindex="-1"></a><span class="fu">rasterImage</span>(heatmap, <span class="dv">0</span>, <span class="dv">0</span>, <span class="fu">ncol</span>(img), <span class="fu">nrow</span>(img), <span class="at">interpolate =</span> <span class="cn">FALSE</span>)</span></code><button title="Kopiuj do schowka" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-seg13" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="segmentation_files/figure-html/fig-seg13-1.png" class="img-fluid figure-img" width="672"></p>
<p></p><figcaption class="figure-caption">Rysunek&nbsp;14.12: Mapa cieplna aktywacji klasy słonia afrykańskiego na zdjęciu testowym</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>Ta technika wizualizacji odpowiada na dwa ważne pytania:</p>
<ul>
<li>Dlaczego sieć uznała, że ten obraz zawiera słonia afrykańskiego?</li>
<li>Gdzie na obrazie znajduje się słoń afrykański?</li>
</ul>
<p>W szczególności interesujące jest to, że uszy słoniowego malca są silnie aktywowane: prawdopodobnie w ten sposób sieć potrafi odróżnić słonie afrykańskie od indyjskich.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://media.giphy.com/media/DAtJCG1t3im1G/giphy.gif" class="img-fluid figure-img"></p>
</figure>
</div>


<div id="refs" class="references csl-bib-body hanging-indent" role="list" style="display: none">
<div id="ref-heDeepResidualLearning2015" class="csl-entry" role="listitem">
He, Kaiming, Xiangyu Zhang, Shaoqing Ren, i Jian Sun. 2015. <span>„Deep <span>Residual Learning</span> for <span>Image Recognition</span>”</span>. <span>arXiv</span>. <a href="https://doi.org/10.48550/arXiv.1512.03385">https://doi.org/10.48550/arXiv.1512.03385</a>.
</div>
<div id="ref-ioffeBatchNormalizationAccelerating2015" class="csl-entry" role="listitem">
Ioffe, Sergey, i Christian Szegedy. 2015. <span>„Batch <span>Normalization</span>: <span>Accelerating Deep Network Training</span> by <span>Reducing Internal Covariate Shift</span>”</span>. <span>arXiv</span>. <a href="https://doi.org/10.48550/arXiv.1502.03167">https://doi.org/10.48550/arXiv.1502.03167</a>.
</div>
<div id="ref-selvarajuGradCAMVisualExplanations2020" class="csl-entry" role="listitem">
Selvaraju, Ramprasaath R., Michael Cogswell, Abhishek Das, Ramakrishna Vedantam, Devi Parikh, i Dhruv Batra. 2020. <span>„Grad-<span>CAM</span>: <span>Visual Explanations</span> from <span>Deep Networks</span> via <span>Gradient-based Localization</span>”</span>. <em>International Journal of Computer Vision</em> 128 (2): 336–59. <a href="https://doi.org/10.1007/s11263-019-01228-7">https://doi.org/10.1007/s11263-019-01228-7</a>.
</div>
</div>
</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  let localAlternateSentinel = 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Skopiowano!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Skopiowano!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Handle positioning of the toggle
      window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
      const annoteTargets = window.document.querySelectorAll('.code-annotation-anchor');
      for (let i=0; i<annoteTargets.length; i++) {
        const annoteTarget = annoteTargets[i];
        const targetCell = annoteTarget.getAttribute("data-target-cell");
        const targetAnnotation = annoteTarget.getAttribute("data-target-annotation");
        const contentFn = () => {
          const content = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          if (content) {
            const tipContent = content.cloneNode(true);
            tipContent.classList.add("code-annotation-tip-content");
            return tipContent.outerHTML;
          }
        }
        const config = {
          allowHTML: true,
          content: contentFn,
          onShow: (instance) => {
            selectCodeLines(instance.reference);
            instance.reference.classList.add('code-annotation-active');
            window.tippy.hideAll();
          },
          onHide: (instance) => {
            unselectCodeLines();
            instance.reference.classList.remove('code-annotation-active');
          },
          maxWidth: 300,
          delay: [50, 0],
          duration: [200, 0],
          offset: [5, 10],
          arrow: true,
          appendTo: function(el) {
            return el.parentElement.parentElement.parentElement;
          },
          interactive: true,
          interactiveBorder: 10,
          theme: 'quarto',
          placement: 'right',
          popperOptions: {
            modifiers: [
            {
              name: 'flip',
              options: {
                flipVariations: false, // true by default
                allowedAutoPlacements: ['right'],
                fallbackPlacements: ['right', 'top', 'top-start', 'top-end'],
              },
            },
            {
              name: 'preventOverflow',
              options: {
                mainAxis: false,
                altAxis: false
              }
            }
            ]        
          }      
        };
        window.tippy(annoteTarget, config); 
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./example.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Przykład uczenia sieci splotowej</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./references.html" class="pagination-link">
        <span class="nav-page-text">Bibliografia</span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">Automatyczna analiza obrazu, Dariusz Majerek</div>   
    <div class="nav-footer-center">
      &nbsp;
    </div>
    <div class="nav-footer-right">Książka została napisana w <a href="https://quarto.org/">Quarto</a></div>
  </div>
</footer>



</body></html>